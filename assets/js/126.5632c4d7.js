(window.webpackJsonp=window.webpackJsonp||[]).push([[126],{532:function(s,a,t){"use strict";t.r(a);var e=t(56),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"cdk"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cdk"}},[s._v("#")]),s._v(" CDK")]),s._v(" "),t("ul",[t("li",[t("p",[t("a",{attrs:{href:"#1-%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8C"}},[s._v("1. 编译运行")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#2-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"}},[s._v("2. 目录结构")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#3-%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3-main"}},[s._v("3. 程序入口 main()")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#4-cli"}},[s._v("4. cli")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#5-evaluate"}},[s._v("5. evaluate")])]),s._v(" "),t("ul",[t("li",[t("p",[t("a",{attrs:{href:"#51-callbasics"}},[s._v("5.1. CallBasics()")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#52-calladdedfunc"}},[s._v("5.2. CallAddedFunc()")])]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#521-searchlocalfilepath"}},[s._v("5.2.1. SearchLocalFilePath()")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#522-aslr"}},[s._v("5.2.2. ASLR()")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#523-dumpcgroup"}},[s._v("5.2.3. DumpCgroup()")])])])])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#6-exploit"}},[s._v("6. exploit")])]),s._v(" "),t("ul",[t("li",[t("p",[t("a",{attrs:{href:"#61-%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"}},[s._v("6.1. 参数解析")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#62-%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91"}},[s._v("6.2. 执行逻辑")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#63-cdk-run---list--%E6%9F%A5%E7%9C%8Bexp%E5%88%97%E8%A1%A8-total-32"}},[s._v("6.3. cdk run --list  查看exp列表 (total 32)")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#64-cdk-run-poc1-args1"}},[s._v("6.4. cdk run poc1 args1")])]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#641-abuse-unpriv-userns"}},[s._v("6.4.1. abuse-unpriv-userns")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#642-ak-leakage"}},[s._v("6.4.2. ak-leakage")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#643-cap-dac-read-search"}},[s._v("6.4.3. cap-dac-read-search")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#644-check-ptrace"}},[s._v("6.4.4. check-ptrace")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#645-docker-api-pwn"}},[s._v("6.4.5. docker-api-pwn")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#646-docker-sock-check"}},[s._v("6.4.6. docker-sock-check")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#647-docker-sock-pwn"}},[s._v("6.4.7. docker-sock-pwn")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#648-etcd-get-k8s-token"}},[s._v("6.4.8. etcd-get-k8s-token")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#649-istio-check"}},[s._v("6.4.9. istio-Check")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6410-k8s-backdoor-daemonset"}},[s._v("6.4.10. k8s-backdoor-daemonset")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6411-k8s-configmap-dump"}},[s._v("6.4.11. k8s-configmap-dump")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6412-k8s-cronjob"}},[s._v("6.4.12. k8s-cronjob")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6413-k8s-get-sa-token"}},[s._v("6.4.13. k8s-get-sa-token")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6414-k8s-kubelet-var-log-escape"}},[s._v("6.4.14. k8s-kubelet-var-log-escape")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6415-k8s-mitm-clusterip"}},[s._v("6.4.15. k8s-mitm-clusterip")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6416-k8s-psp-dump"}},[s._v("6.4.16. k8s-psp-dump")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6417-k8s-secret-dump"}},[s._v("6.4.17. k8s-secret-dump")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6418-k8s-shadow-apiserver"}},[s._v("6.4.18. k8s-shadow-apiserver")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6419-kubelet-exec"}},[s._v("6.4.19. kubelet-exec")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6420-lxcfs-rw"}},[s._v("6.4.20. lxcfs-rw")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6421-lxcfs-rw-cgroup"}},[s._v("6.4.21. lxcfs-rw-cgroup")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6422-mount-cgroup"}},[s._v("6.4.22. mount-cgroup")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6423-mount-disk"}},[s._v("6.4.23. mount-disk")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6424-mount-procfs"}},[s._v("6.4.24. mount-procfs")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6425-registry-brute"}},[s._v("6.4.25. registry-brute")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6426-reverse-shell"}},[s._v("6.4.26. reverse-shell")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6427-rewrite-cgroup-devices"}},[s._v("6.4.27. rewrite-cgroup-devices")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6428-runc-pwn"}},[s._v("6.4.28. runc-pwn")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6429-service-probe"}},[s._v("6.4.29. service-probe")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6430-shim-pwn"}},[s._v("6.4.30. shim-pwn")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#6431-webshell-deploy"}},[s._v("6.4.31. webshell-deploy")])])])])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#7-tool-%E9%83%A8%E5%88%86"}},[s._v("7. tool 部分")])])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"#8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"}},[s._v("8. 参考资料")])])])]),s._v(" "),t("h2",{attrs:{id:"_1-编译运行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-编译运行"}},[s._v("#")]),s._v(" 1. 编译运行")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("\ngitclonehttps://github.com/cdk-team/CDK/\n\ncdCDK\n\ngobuildcmd/cdk/cdk.go\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h2",{attrs:{id:"_2-目录结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-目录结构"}},[s._v("#")]),s._v(" 2. 目录结构")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("\n├──cmd\n\n│   └──cdk  //入口函数\n\n├──conf\n\n├──go.mod\n\n├──go.sum\n\n├──LICENSE\n\n├──pkg\n\n│   ├──cli  //命令行参数解析\n\n│   ├──errors  //自定义CDKRuntimeError\n\n│   ├──evaluate//本地信息收集\n\n│   ├──exploit  //exp\n\n│   ├──plugin  //插件管理接口\n\n│   ├──task   //自动逃逸代码\n\n│   ├──tool  //工具集ncviifconfigpscurl端口扫描等\n\n│   └──util  //一些功能函数\n\n├──README.md\n\n├──test\n\n│   ├──CDK-deploy-test\n\n│   ├──k8s_exploit_util\n\n│   ├──scan_file_path\n\n│   └──scan_file_text\n\n└──thanks.md\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br")])]),t("p",[s._v("一共大约 8000 行代码，需要重点关注启动 pkg 下面的 6000 行代码。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("\n     134textfiles.\n\n     132uniquefiles.\n\n      15filesignored.\n\n\ngithub.com/AlDanial/clocv1.74  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("T")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".29s "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("416.0")]),s._v(" files/s,40163.5lines/s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n-------------------------------------------------------------------------------\n\nLanguage                     files          blank        comment           code\n\n-------------------------------------------------------------------------------\n\nGo                              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("95")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1614")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1923")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6396")]),s._v("\n\nPython                           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("102")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("859")]),s._v("\n\nMarkdown                         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("274")]),s._v("\n\nYAML                            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253")]),s._v("\n\nBourneShell                     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v("\n\nJSON                             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("\n\n-------------------------------------------------------------------------------\n\nSUM:                           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("122")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1895")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2039")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7846")]),s._v("\n\n-------------------------------------------------------------------------------\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("h2",{attrs:{id:"_3-程序入口-main"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-程序入口-main"}},[s._v("#")]),s._v(" 3. 程序入口 main()")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("funcmain")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    cli"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ParseCDKMain")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h2",{attrs:{id:"_4-cli"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-cli"}},[s._v("#")]),s._v(" 4. cli")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\ncmd/cdk/cdk.go --\x3e main() --\x3e cli.ParseCDKMain()\n\n\ndocopt/docopt-go 命令行参数解析\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h2",{attrs:{id:"_5-evaluate"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-evaluate"}},[s._v("#")]),s._v(" 5. evaluate")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" fok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n        fmt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BannerHeader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        evaluate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("CallBasics")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" Args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--full"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n            evaluate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("CallAddedFunc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        returntrue\n\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"_5-1-callbasics"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-callbasics"}},[s._v("#")]),s._v(" 5.1. CallBasics()")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("BasicSysInfo()")]),s._v(" "),t("ul",[t("li",[s._v("os.Getwd()")]),s._v(" "),t("li",[s._v("os/user.Current()")]),s._v(" "),t("li",[s._v("os.Hostname()")]),s._v(" "),t("li",[s._v("gopsutil/v3/host.KernelVersion()")])])]),s._v(" "),t("li",[t("p",[s._v("FindSidFiles()")]),s._v(" "),t("ul",[t("li",[s._v("find /bin/. -perm -4000 -type f 查找具有 suid 权限的文件")])])]),s._v(" "),t("li",[t("p",[s._v("SearchSensitiveEnv()")]),s._v(" "),t("ul",[t("li",[s._v("查找有用的环境变量")]),s._v(" "),t("li",[s._v("os.Environ()")]),s._v(" "),t("li",[s._v("regexp.MatchString(conf.SensitiveEnvRegex, env)")])])]),s._v(" "),t("li",[t("p",[s._v("SearchSensitiveService()")]),s._v(" "),t("ul",[t("li",[s._v("查找有用的环境进程")]),s._v(" "),t("li",[s._v("gops.Processes()")]),s._v(" "),t("li",[s._v("regexp.MatchString(conf.SensitiveProcessRegex, proc.Executable())")])])]),s._v(" "),t("li",[t("p",[s._v("SearchAvailableCommands()")]),s._v(" "),t("ul",[t("li",[s._v("检查命令是否存在")]),s._v(" "),t("li",[s._v("exec.LookPath(cmd)")])])]),s._v(" "),t("li",[t("p",[s._v("GetProcCapabilities()")]),s._v(" "),t("ul",[t("li",[s._v("获取进程的 Capabilities 信息, 获取进程的权限")]),s._v(" "),t("li",[s._v("/proc/self/status")]),s._v(" "),t("li",[s._v('strings.HasPrefix(line, "Cap")')]),s._v(" "),t("li",[s._v("pattern.FindStringSubmatch(string(data))")])])]),s._v(" "),t("li",[t("p",[s._v("MountEscape()")]),s._v(" "),t("ul",[t("li",[s._v("获取文件系统挂载信息")]),s._v(" "),t("li",[s._v("cat /proc/self/mountinfo")])])]),s._v(" "),t("li",[t("p",[s._v("CheckNetNamespace()")]),s._v(" "),t("ul",[t("li",[s._v("匹配敏感的 unix 套接字")]),s._v(" "),t("li",[s._v("cat /proc/net/unix")])])]),s._v(" "),t("li",[t("p",[s._v("CheckRouteLocalNetworkValue()")]),s._v(" "),t("ul",[t("li",[s._v("检查网络设备转发 lo 设备数据包的功能")]),s._v(" "),t("li",[s._v("cat /proc/sys/net/ipv4/conf/all/route_localnet")])])]),s._v(" "),t("li",[t("p",[s._v("CheckK8sAnonymousLogin()")]),s._v(" "),t("ul",[t("li",[s._v("检查 api-server 是否允许匿名请求")]),s._v(" "),t("li",[s._v("kubectl.ServerAccountRequest")])])]),s._v(" "),t("li",[t("p",[s._v("CheckPrivilegedK8sServiceAccount(conf.K8sSATokenDefaultPath)")]),s._v(" "),t("ul",[t("li",[s._v("检查服务账户是否可用 kubectl.ServerAccountRequest")]),s._v(" "),t("li",[s._v("如果可用会尝试列出 namespaces kubectl.ServerAccountRequest")])])]),s._v(" "),t("li",[t("p",[s._v("CheckCloudMetadataAPI()")]),s._v(" "),t("ul",[t("li",[s._v("请求 conf.CloudAPI 获取 Metadata API 信息")])])]),s._v(" "),t("li",[t("p",[s._v("DNSBasedServiceDiscovery()")]),s._v(" "),t("ul",[t("li",[s._v("net.LookupSRV")]),s._v(" "),t("li",[s._v("基于 dns 进行服务发现 "),t("code",[s._v("https://github.com/kubernetes/dns/blob/master/docs/specification.md")])])])])]),s._v(" "),t("h3",{attrs:{id:"_5-2-calladdedfunc"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-calladdedfunc"}},[s._v("#")]),s._v(" 5.2. CallAddedFunc()")]),s._v(" "),t("h4",{attrs:{id:"_5-2-1-searchlocalfilepath"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-1-searchlocalfilepath"}},[s._v("#")]),s._v(" 5.2.1. SearchLocalFilePath()")]),s._v(" "),t("p",[s._v("遍历本地文件，查找是否有在 sensitiveFileRules.NameList 里的文件")]),s._v(" "),t("p",[s._v("SearchLocalFilePath() -> filepath.Walk() -> strings.Contains()")]),s._v(" "),t("h4",{attrs:{id:"_5-2-2-aslr"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-2-aslr"}},[s._v("#")]),s._v(" 5.2.2. ASLR()")]),s._v(" "),t("p",[s._v("检查栈随机化是否开启; "),t("code",[s._v("/proc/sys/kernel/randomize_va_space == 0")])]),s._v(" "),t("h4",{attrs:{id:"_5-2-3-dumpcgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-3-dumpcgroup"}},[s._v("#")]),s._v(" 5.2.3. DumpCgroup()")]),s._v(" "),t("p",[s._v("获取进程(1 与 self)的 cgroup 信息 "),t("code",[s._v("/proc/1/cgroup``/proc/self/cgroup")])]),s._v(" "),t("p",[s._v("util.GetCgroup()")]),s._v(" "),t("h2",{attrs:{id:"_6-exploit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-exploit"}},[s._v("#")]),s._v(" 6. exploit")]),s._v(" "),t("h3",{attrs:{id:"_6-1-参数解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-参数解析"}},[s._v("#")]),s._v(" 6.1. 参数解析")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" Args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"run"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" Args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--list"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// cdk run --list 查看所有的exp")]),s._v("\n\n            plugin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ListAllExploit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 列出所有的exp")]),s._v("\n\n            os"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" Args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<exploit>"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" plugin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Exploits"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n            fmt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\nInvalid script name: %s , available scripts:\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n            plugin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ListAllExploit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n            returntrue\n\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        plugin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("RunSingleExploit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行对应的exp")]),s._v("\n\n        returntrue\n\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("h3",{attrs:{id:"_6-2-执行逻辑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-执行逻辑"}},[s._v("#")]),s._v(" 6.2. 执行逻辑")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("plugin下定义了Exploits的全局变量用来保存exp信息。")])]),s._v(" "),t("li",[t("p",[s._v('exploit下的exp中的init()函数调用plugin.RegisterExploit("xxx", exploit)注册exp到Exploits中')])]),s._v(" "),t("li",[t("p",[s._v("以docker_runc.go为例")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("init()")])]),s._v(" "),t("li",[t("p",[s._v("dockerRuncPwnS 接口")]),s._v(" "),t("ul",[t("li",[s._v("Desc() 返回exp的说明")]),s._v(" "),t("li",[s._v("Run() 执行exp")])])]),s._v(" "),t("li",[t("p",[s._v("dockerRuncPwn(hijackCommand string) 最终的漏洞检测函数")])])])])]),s._v(" "),t("h3",{attrs:{id:"_6-3-cdk-run-list-查看exp列表-total-32"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-cdk-run-list-查看exp列表-total-32"}},[s._v("#")]),s._v(" 6.3. cdk run --list  查看exp列表 (total 32)")]),s._v(" "),t("h3",{attrs:{id:"_6-4-cdk-run-poc1-args1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-cdk-run-poc1-args1"}},[s._v("#")]),s._v(" 6.4. cdk run poc1 args1")]),s._v(" "),t("h4",{attrs:{id:"_6-4-1-abuse-unpriv-userns"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-1-abuse-unpriv-userns"}},[s._v("#")]),s._v(" 6.4.1. abuse-unpriv-userns")]),s._v(" "),t("p",[s._v("利用 CVE-2022-0492 进行自动化逃逸。")]),s._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://github.com/cdk-team/CDK/wiki/Exploit:-abuse-unpriv-userns",target:"_blank",rel:"noopener noreferrer"}},[s._v("Exploit: abuse unpriv userns"),t("OutboundLink")],1)])]),s._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://nosec.org/home/detail/4973.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("深入分析CVE-2022-0492漏洞"),t("OutboundLink")],1)])]),s._v(" "),t("h4",{attrs:{id:"_6-4-2-ak-leakage"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-2-ak-leakage"}},[s._v("#")]),s._v(" 6.4.2. ak-leakage")]),s._v(" "),t("ul",[t("li",[s._v("查找本地泄漏的Ak/Secrets等敏感信息")]),s._v(" "),t("li",[s._v("usage: cdk run ak-leakage "),t("code",[s._v("<dir>")])]),s._v(" "),t("li",[s._v("Run() -> SearchLocalFileText(path) -> filepath.Walk() -> FindAllStringSubmatch")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-3-cap-dac-read-search"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-3-cap-dac-read-search"}},[s._v("#")]),s._v(" 6.4.3. cap-dac-read-search")]),s._v(" "),t("ul",[t("li",[s._v("CAP_DAC_READ_SEARCH 能够绕过文件的读权限检查和目录的读和执行权限检查；")]),s._v(" "),t("li",[s._v("RUN() -> CapDacReadSearchExploit(target, ref, chroot, cmd) -> execCommand(cmd)")])]),s._v(" "),t("p",[s._v("-"),t("code",[s._v('docker run -it --rm --cap-add CAP_DAC_READ_SEARCH -v "$(pwd)/cdk":/cdk ubuntu /bin/bash``cdk run cap-dac-read-search /etc/shadow')])]),s._v(" "),t("h4",{attrs:{id:"_6-4-4-check-ptrace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-4-check-ptrace"}},[s._v("#")]),s._v(" 6.4.4. check-ptrace")]),s._v(" "),t("ul",[t("li",[s._v("检查SYS_PTRACE标志位,同时打印容器内部进程列表")]),s._v(" "),t("li",[s._v("如果存在ptrace权限，容器同时挂载了主机的pid namespace 就可以逃逸")]),s._v(" "),t("li",[s._v('RUN() -> CheckPidInject() -> ioutil.ReadFile("/proc/self/status") -> FindAllStringSubmatch() -> enableSysPtraceCap(mask) -> ps.RunPs()')])]),s._v(" "),t("h4",{attrs:{id:"_6-4-5-docker-api-pwn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-5-docker-api-pwn"}},[s._v("#")]),s._v(" 6.4.5. docker-api-pwn")]),s._v(" "),t("ul",[t("li",[s._v("Docker API 2375未授权访问，控制宿主机的dockerd创建一个新容器，并挂在宿主机根目录/到容器内部/host，然后执行传入的命令")]),s._v(" "),t("li",[s._v("Run() -> DockerRemoteAPIExploit(url, cmd) -> CheckDockerRemoteAPI(api) -> pull image -> create container -> get container id -> start container")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-6-docker-sock-check"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-6-docker-sock-check"}},[s._v("#")]),s._v(" 6.4.6. docker-sock-check")]),s._v(" "),t("ul",[t("li",[s._v("检查docker unix socket是否可用")]),s._v(" "),t("li",[s._v('Run() -> CheckDockerSock(sock) -> os.Stat(path)->　util.UnixHttpSend("get", path, "http://127.0.0.1/info", "")')])]),s._v(" "),t("h4",{attrs:{id:"_6-4-7-docker-sock-pwn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-7-docker-sock-pwn"}},[s._v("#")]),s._v(" 6.4.7. docker-sock-pwn")]),s._v(" "),t("ul",[t("li",[s._v("检查docker.sock能否访问，如果能尝试启动alpine容器执行命令")]),s._v(" "),t("li",[s._v('Run() -> DockerSockExploit(sock, cmd) -> CheckDockerSock(sock) -> DockerAPIPull(sock, "alpine:latest") -> DockerAPIRun(sock, cmd)')])]),s._v(" "),t("h4",{attrs:{id:"_6-4-8-etcd-get-k8s-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-8-etcd-get-k8s-token"}},[s._v("#")]),s._v(" 6.4.8. etcd-get-k8s-token")]),s._v(" "),t("ul",[t("li",[s._v("通过etcd获取k8s的toekn")])]),s._v(" "),t("p",[s._v("-> Run() -> etcdctl.DoRequest(opt) -> etcdctl.GetKeys -> etcdctl.GetKeys(resp1, opt.Silent) -> getPods(token, endpoint)")]),s._v(" "),t("h4",{attrs:{id:"_6-4-9-istio-check"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-9-istio-check"}},[s._v("#")]),s._v(" 6.4.9. istio-Check")]),s._v(" "),t("ul",[t("li",[s._v("检查当前的shell是否在istio(service mesh)中")]),s._v(" "),t("li",[s._v('Run() -> http.Get("http://httpbin.org/get") -> strings.Contains(result.Header.XEnvoyPeerMetadataId, "sidecar")')])]),s._v(" "),t("h4",{attrs:{id:"_6-4-10-k8s-backdoor-daemonset"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-10-k8s-backdoor-daemonset"}},[s._v("#")]),s._v(" 6.4.10. k8s-backdoor-daemonset")]),s._v(" "),t("ul",[t("li",[s._v("通过daemonset将用户指定的后门镜像部署到每个node。")]),s._v(" "),t("li")]),s._v(" "),t("h4",{attrs:{id:"_6-4-11-k8s-configmap-dump"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-11-k8s-configmap-dump"}},[s._v("#")]),s._v(" 6.4.11. k8s-configmap-dump")]),s._v(" "),t("ul",[t("li",[s._v("拉取全部K8s Configmap信息保存到本地文件。")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-12-k8s-cronjob"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-12-k8s-cronjob"}},[s._v("#")]),s._v(" 6.4.12. k8s-cronjob")]),s._v(" "),t("ul",[t("li",[s._v("部署K8s CronJob定时创建用户指定的image并运行cmd。")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-13-k8s-get-sa-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-13-k8s-get-sa-token"}},[s._v("#")]),s._v(" 6.4.13. k8s-get-sa-token")]),s._v(" "),t("ul",[t("li",[s._v("绕过K8s RBAC")]),s._v(" "),t("li",[s._v("如果当前的Pod有创建Pod权限，提权到Cluster Admin")]),s._v(" "),t("li",[s._v("创建一个Pod并挂在目标service-account的token")]),s._v(" "),t("li",[s._v("在Pod中读取该token并发送到攻击者的公网服务器。")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-14-k8s-kubelet-var-log-escape"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-14-k8s-kubelet-var-log-escape"}},[s._v("#")]),s._v(" 6.4.14. k8s-kubelet-var-log-escape")]),s._v(" "),t("ul",[t("li",[s._v("Exploit container escape with kubelet log access & /var/log mount")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-15-k8s-mitm-clusterip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-15-k8s-mitm-clusterip"}},[s._v("#")]),s._v(" 6.4.15. k8s-mitm-clusterip")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("K8s中间人攻击(CVE-2020-8554)")])]),s._v(" "),t("li",[t("p",[s._v("漏洞只影响部分CNI插件和网络模式")]),s._v(" "),t("ul",[t("li",[s._v("部分CNI + Iptables 可劫持 POD network")]),s._v(" "),t("li",[s._v("部分CNI + IPVS 可劫持 可劫持 NODE network")]),s._v(" "),t("li",[s._v("Global Router + IPVS 可劫持 可劫持 NODE network")])])])]),s._v(" "),t("h4",{attrs:{id:"_6-4-16-k8s-psp-dump"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-16-k8s-psp-dump"}},[s._v("#")]),s._v(" 6.4.16. k8s-psp-dump")]),s._v(" "),t("ul",[t("li",[s._v("对于已经获取了kubeconfig或sa账号权限，进而想要创建特殊配置的容器，但是受到了K8s Pod Security Policies的限制时；")]),s._v(" "),t("li",[s._v("获取Pod Security Policies的规则信息。")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-17-k8s-secret-dump"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-17-k8s-secret-dump"}},[s._v("#")]),s._v(" 6.4.17. k8s-secret-dump")]),s._v(" "),t("ul",[t("li",[s._v("拉取全部K8s Secrets")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-18-k8s-shadow-apiserver"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-18-k8s-shadow-apiserver"}},[s._v("#")]),s._v(" 6.4.18. k8s-shadow-apiserver")]),s._v(" "),t("ul",[t("li",[s._v("部署一个shadow apiserver，该apiserver具有和集群中现存的apiserver一致的功能，同时开启了全部K8s管理权限，接受匿名请求且不保存审计日志。便于攻击者无痕迹的管理整个集群以及下发后续渗透行动。")]),s._v(" "),t("li",[s._v("需要master node的create pod权限")]),s._v(" "),t("li",[s._v("在攻入的pod内部查找API-server访问地址和凭据")]),s._v(" "),t("li",[s._v("连接apiserver判断权限")]),s._v(" "),t("li",[s._v("获取apiserver原有配置")]),s._v(" "),t("li",[s._v("修改配置")]),s._v(" "),t("li",[s._v("重新部署shadow apiserver")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-19-kubelet-exec"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-19-kubelet-exec"}},[s._v("#")]),s._v(" 6.4.19. kubelet-exec")]),s._v(" "),t("ul",[t("li",[s._v("Attack the kubelet endpoint.Support anonymous access or token designation")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-20-lxcfs-rw"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-20-lxcfs-rw"}},[s._v("#")]),s._v(" 6.4.20. lxcfs-rw")]),s._v(" "),t("ul",[t("li",[s._v("POD挂载了LXCFS目录包含CGOURP目录，并且对CGROUP有写权限")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-21-lxcfs-rw-cgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-21-lxcfs-rw-cgroup"}},[s._v("#")]),s._v(" 6.4.21. lxcfs-rw-cgroup")]),s._v(" "),t("ul",[t("li",[s._v("escape container by cgroup when root has LXCFS read & write privilege,")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-22-mount-cgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-22-mount-cgroup"}},[s._v("#")]),s._v(" 6.4.22. mount-cgroup")]),s._v(" "),t("ul",[t("li",[s._v("逃逸与宿主机共享cgroup的容器")]),s._v(" "),t("li",[s._v("将宿主机cgroup目录挂载到容器内，随后劫持宿主机cgroup的release_agent文件，通过linux cgroup notify_on_release机制触发shellcode执行，完成逃逸。")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-23-mount-disk"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-23-mount-disk"}},[s._v("#")]),s._v(" 6.4.23. mount-disk")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("自动化逃逸有设备操作权限的容器")]),s._v(" "),t("ul",[t("li",[s._v("识别当前容器内的挂载情况")]),s._v(" "),t("li",[s._v("将宿主机的物理磁盘挂载到容器中")]),s._v(" "),t("li",[s._v("编辑宿主机文件(如修改宿主机的/etc/crontab)完成逃逸。")])])]),s._v(" "),t("li",[t("p",[s._v("Run()")]),s._v(" "),t("ul",[t("li",[s._v("AllDiskMount()")]),s._v(" "),t("li",[s._v("disk.Partitions(false)")]),s._v(" "),t("li",[s._v("util.RemoveDuplicateElement(devices)")]),s._v(" "),t("li",[s._v("MountToRandomTarget(device)")])])])]),s._v(" "),t("h4",{attrs:{id:"_6-4-24-mount-procfs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-24-mount-procfs"}},[s._v("#")]),s._v(" 6.4.24. mount-procfs")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("逃逸挂载宿主机/proc目录的容器")]),s._v(" "),t("ul",[t("li",[s._v("将用户指定的shell命令指向宿主机/sys/kernel/core_pattern文件，在容器空间通过segment fault触发core dump，进而触发shellcode执行。")])])]),s._v(" "),t("li",[t("p",[s._v("Run()")])]),s._v(" "),t("li",[t("p",[s._v("ProcfsExploit(procDir, shellPayload)")])]),s._v(" "),t("li",[t("p",[s._v("checkEnvFirst()")])]),s._v(" "),t("li",[t("p",[s._v("GetDockerAbsPath()")])]),s._v(" "),t("li",[t("p",[s._v("util.RandString(5)")])]),s._v(" "),t("li",[t("p",[s._v("util.RewriteFile")])]),s._v(" "),t("li",[t("p",[s._v("triggerSegmentFault()")])])]),s._v(" "),t("h4",{attrs:{id:"_6-4-25-registry-brute"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-25-registry-brute"}},[s._v("#")]),s._v(" 6.4.25. registry-brute")]),s._v(" "),t("ul",[t("li",[s._v("暴力破解registry")]),s._v(" "),t("li",[s._v("Run() -> checkLogin() -> http.Client{}.Do()")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-26-reverse-shell"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-26-reverse-shell"}},[s._v("#")]),s._v(" 6.4.26. reverse-shell")]),s._v(" "),t("ul",[t("li",[s._v("执行一个反弹shell")]),s._v(" "),t("li",[s._v("Run() -> ReverseShell() -> os/exec.Command().Run()")])]),s._v(" "),t("h4",{attrs:{id:"_6-4-27-rewrite-cgroup-devices"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-27-rewrite-cgroup-devices"}},[s._v("#")]),s._v(" 6.4.27. rewrite-cgroup-devices")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("sys_admin")])]),s._v(" "),t("li",[t("p",[s._v("Run()")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("newDevicesCgroup()")]),s._v(" "),t("ul",[t("li",[s._v("mount -t cgroup -o devices devices /tmp/cdk_dcgroup**")])])]),s._v(" "),t("li",[t("p",[s._v("findCurrentCgroupENV()")])]),s._v(" "),t("li",[t("p",[s._v("util.GetMountInfo()")])]),s._v(" "),t("li",[t("p",[s._v("util.SetBlockAccessible(devicesAllowPath)")])]),s._v(" "),t("li",[t("p",[s._v("util.FindTargetDeviceID(&mi)")]),s._v(" "),t("ul",[t("li",[s._v("util.MakeDev(mi.Major, mi.Minor)")]),s._v(" "),t("li",[s._v('syscall.Mknod("./cdk_mknod_result", syscall.S_IFBLK|uint32(os.FileMode(0700)), dev)')])])])])])]),s._v(" "),t("h4",{attrs:{id:"_6-4-28-runc-pwn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-28-runc-pwn"}},[s._v("#")]),s._v(" 6.4.28. runc-pwn")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("CVE-2019-5736")]),s._v(" "),t("ul",[t("li",[s._v("过特定的容器镜像或者exec操作可以获取到宿主机的runc执行时的文件句柄并修改掉runc的二进制文件，从而获取到宿主机的root执行权限")]),s._v(" "),t("li",[s._v("影响版本 Docker版本 < 18.09.2 or runc版本 <= 1.0-rc6")])])]),s._v(" "),t("li",[t("p",[s._v("Run() - dockerRuncPwn(cmd)")])])]),s._v(" "),t("h4",{attrs:{id:"_6-4-29-service-probe"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-29-service-probe"}},[s._v("#")]),s._v(" 6.4.29. service-probe")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("端口扫描")])]),s._v(" "),t("li",[t("p",[s._v("Run()")])]),s._v(" "),t("li",[t("p",[s._v("probe.TCPScanExploitAPI(args[0])")]),s._v(" "),t("ul",[t("li",[s._v('net.DialTimeout("tcp", target, timeout)')])])])]),s._v(" "),t("h4",{attrs:{id:"_6-4-30-shim-pwn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-30-shim-pwn"}},[s._v("#")]),s._v(" 6.4.30. shim-pwn")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("自动化逃逸CVE-2020-15257，反弹宿主机的shell到远端服务器。")])]),s._v(" "),t("li",[t("p",[s._v("Run()")])]),s._v(" "),t("li",[t("p",[s._v("ContainerdPwn()")]),s._v(" "),t("ul",[t("li",[s._v('ContainerdPwn(shellCmd, "", "")')]),s._v(" "),t("li",[s._v('ContainerdPwn(shellCmd, "", "")')])])]),s._v(" "),t("li",[t("p",[s._v("getShimSockets()")])]),s._v(" "),t("li",[t("p",[s._v("containerdShimApiExp()")])])]),s._v(" "),t("h4",{attrs:{id:"_6-4-31-webshell-deploy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-31-webshell-deploy"}},[s._v("#")]),s._v(" 6.4.31. webshell-deploy")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("生成接受随机POST参数的PHP或JSP webshell写入指定文件。")]),s._v(" "),t("ul",[t("li",[s._v('var WebShellCodeJSP = "<%Runtime.getRuntime().exec(request.getParameter("$SECRET_PARAM"));%>"')]),s._v(" "),t("li",[s._v('var WebShellCodePHP = "'),t("code",[s._v("<?php @eval($_POST['$SECRET_PARAM']);?>")]),s._v('"')])])]),s._v(" "),t("li",[t("p",[s._v('Run() -> deployWebShell(fileType,path) -> param = "cdk_" + util.RandString(7)')])])]),s._v(" "),t("h2",{attrs:{id:"_7-tool-部分"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-tool-部分"}},[s._v("#")]),s._v(" 7. tool 部分")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("dockerd_api")]),s._v(" "),t("ul",[t("li",[s._v("ucurl")]),s._v(" "),t("li",[s._v("dcurl")]),s._v(" "),t("li",[s._v("net.http")])])]),s._v(" "),t("li",[t("p",[s._v("etcdctl")]),s._v(" "),t("ul",[t("li",[s._v("ectl http.NewRequest")])])]),s._v(" "),t("li",[t("p",[s._v("kubectl")]),s._v(" "),t("ul",[t("li",[s._v("kcurl http.NewRequest")])])]),s._v(" "),t("li",[t("p",[s._v("netcat")]),s._v(" "),t("ul",[t("li",[s._v("net.ListenPacket")]),s._v(" "),t("li",[s._v("net.Dial")]),s._v(" "),t("li",[s._v("io.Copy")])])]),s._v(" "),t("li",[t("p",[s._v("network")]),s._v(" "),t("ul",[t("li",[s._v("ifcofnig net.Interfaces()")])])]),s._v(" "),t("li",[t("p",[s._v("probe")]),s._v(" "),t("ul",[t("li",[s._v("tcp connet 端口扫描 net.DialTimeout")])])]),s._v(" "),t("li",[t("p",[s._v("ps")]),s._v(" "),t("ul",[t("li",[s._v("github.com/shirou/gopsutil 获取系统信息的一个包，类似 python 的 psutil")])])]),s._v(" "),t("li",[t("p",[s._v("vi")]),s._v(" "),t("p",[s._v("-"),t("code",[s._v("https://github.com/bkthomps/Ven")]),s._v(" 一个 go 写类似 vim 的文本编辑器")])])]),s._v(" "),t("h2",{attrs:{id:"_8-参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-参考资料"}},[s._v("#")]),s._v(" 8. 参考资料")]),s._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://www.freebuf.com/sectool/261432.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("CDK：一款针对容器场景的渗透工具"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);