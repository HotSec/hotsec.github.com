(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{424:function(s,t,a){"use strict";a.r(t);var n=a(56),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"_1-openresty环境安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-openresty环境安装"}},[s._v("#")]),s._v(" 1. openresty环境安装")]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#_1-1-openresty-hello-world"}},[s._v('1.1. OpenResty "hello world"')])]),a("li",[a("a",{attrs:{href:"#_1-2-nginx-conf"}},[s._v("1.2. Nginx.conf")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1-2-1-http块"}},[s._v("1.2.1. HTTP块")])]),a("li",[a("a",{attrs:{href:"#_1-2-2-tcp-udp服务"}},[s._v("1.2.2. TCP/UDP服务")])]),a("li",[a("a",{attrs:{href:"#_1-2-3-日志"}},[s._v("1.2.3. 日志")])])])]),a("li",[a("a",{attrs:{href:"#_1-3-负载均衡"}},[s._v("1.3. 负载均衡")])]),a("li",[a("a",{attrs:{href:"#_1-4-nginx-变量"}},[s._v("1.4. Nginx 变量")])]),a("li",[a("a",{attrs:{href:"#_1-5-nginx下lua实现机制"}},[s._v("1.5. Nginx下Lua实现机制")])]),a("li",[a("a",{attrs:{href:"#_1-6-openresty组成"}},[s._v("1.6. OpenResty组成")])]),a("li",[a("a",{attrs:{href:"#_1-7-openresty目录结构"}},[s._v("1.7. OpenResty目录结构")])]),a("li",[a("a",{attrs:{href:"#_1-8-组件管理工具"}},[s._v("1.8. 组件管理工具")])]),a("li",[a("a",{attrs:{href:"#_1-9-命令行工具"}},[s._v("1.9. 命令行工具")])]),a("li",[a("a",{attrs:{href:"#_1-10-restydoc"}},[s._v("1.10. restydoc")])]),a("li",[a("a",{attrs:{href:"#_1-11-ngx-lua"}},[s._v("1.11. ngx_lua")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1-11-1-配置指令"}},[s._v("1.11.1. 配置指令")])]),a("li",[a("a",{attrs:{href:"#_1-11-2-功能指令"}},[s._v("1.11.2. 功能指令")])]),a("li",[a("a",{attrs:{href:"#_1-11-3-ngx-lua指令关系图"}},[s._v("1.11.3. ngx_lua指令关系图")])]),a("li",[a("a",{attrs:{href:"#_1-11-4-应用开发流程"}},[s._v("1.11.4. 应用开发流程")])])])]),a("li",[a("a",{attrs:{href:"#_1-12-功能接口"}},[s._v("1.12. 功能接口")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1-12-1-运行日志"}},[s._v("1.12.1. 运行日志")])]),a("li",[a("a",{attrs:{href:"#_1-12-2-时间与日期"}},[s._v("1.12.2. 时间与日期")])]),a("li",[a("a",{attrs:{href:"#_1-12-3-变量-ngx-var"}},[s._v("1.12.3. 变量 ngx.var")])]),a("li",[a("a",{attrs:{href:"#_1-12-4-正则"}},[s._v("1.12.4. 正则")])]),a("li",[a("a",{attrs:{href:"#_1-12-5-请求处理"}},[s._v("1.12.5. 请求处理")])]),a("li",[a("a",{attrs:{href:"#_1-12-6-请求转发"}},[s._v("1.12.6. 请求转发")])]),a("li",[a("a",{attrs:{href:"#_1-12-7-子请求"}},[s._v("1.12.7. 子请求")])]),a("li",[a("a",{attrs:{href:"#_1-12-8-定时器"}},[s._v("1.12.8. 定时器")])]),a("li",[a("a",{attrs:{href:"#_1-12-9-共享内存"}},[s._v("1.12.9. 共享内存")])])])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"_1-1-openresty-hello-world"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-openresty-hello-world"}},[s._v("#")]),s._v(' 1.1. OpenResty "hello world"')]),s._v(" "),a("p",[s._v("创建以下目录")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" ~/work\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ~/work\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" logs/ conf/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("创建一个"),a("code",[s._v("conf/nginx.conf")]),s._v("文件")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("worker_processes  1;\nerror_log logs/error.log;\nevents {\n    worker_connections 1024;\n}\nhttp {\n    server {\n        listen 8080;1\n        location / {\n            default_type text/html;\n            content_by_lua '\n                ngx.say(\"<p>hello, world</p>\")\n            ';\n        }\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[a("code",[s._v("curl http://localhost:8080")])]),s._v(" "),a("p",[s._v("nginx多实例，只需要把OpenRestry中的Nginx目录复制一份就可以。")]),s._v(" "),a("p",[s._v("cp -r /usr/local/openrestry/nginx /usr/local/openrestry/nginx_9090")]),s._v(" "),a("p",[s._v("然后修改nginx.conf中的端口从8080改为9090,把hello world改为hello 9090")]),s._v(" "),a("p",[s._v("/usr/local/openrestry/nginx_9090/sbin/nginx -p /usr/local/openrestry/nginx_9090")]),s._v(" "),a("p",[s._v("压力测试 "),a("code",[s._v("ab -c 100 -n 10000 127.0.0.1:8088/hello")]),s._v(" 并发100个连接，10000个请求")]),s._v(" "),a("h2",{attrs:{id:"_1-2-nginx-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-nginx-conf"}},[s._v("#")]),s._v(" 1.2. Nginx.conf")]),s._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://blog.csdn.net/jackliu16/article/details/79444327",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/jackliu16/article/details/79444327"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("nginx配置文件：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("#")]),s._v(" 单行注释")]),s._v(" "),a("li",[s._v("单引号或者双引号 -- 定义字符串   "),a("code",[s._v("\\")]),s._v(" 可以使用转义字符")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("$var")]),s._v(" 可以引用预定义的一些变量")]),s._v(" "),a("li",[s._v("配置指令以分号结束，可以接受多个参数，用空白字符分隔")]),s._v(" "),a("li",[s._v("配置块（block）是特殊的配置指令，它有一个 "),a("code",[s._v("{}")]),s._v(" 参数而且无需分号结束， "),a("code",[s._v("{}")]),s._v(" 里面可以书写多个配置指令，配置块也允许嵌套")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("include")]),s._v(" 指令可以包含其他配置文件，支持 "),a("code",[s._v("*")]),s._v(" 通配符")]),s._v(" "),a("li",[s._v("不能识别或错误的配置指令会导致nginx启动失败")])]),s._v(" "),a("h3",{attrs:{id:"_1-2-1-http块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-http块"}},[s._v("#")]),s._v(" 1.2.1. HTTP块")]),s._v(" "),a("p",[a("strong",[s._v("HTTP服务")]),s._v("\n配置HTTP服务相关的功能需要指令http{},常用形式如下：")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http {\n    server {\n        listen 80;\n        locatim uri {\n            ...\n        }\n    }\n\n    server {        # server 块，第二个Web服务\n        listen xxx;\n        ...\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("可以使用"),a("code",[s._v("include")])]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http {  # http配置块的开始，所有HTTP相关功能\n    include common.conf     # 基本的HTTP配置模块，配置通用参数\n    include servers/*.conf      # 包含 servers目录下所有web服务配置文件\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("server配置")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http {\n    server {\n        listen 8080;    # 监听端口，默认是80\n        server_name *.*;  # OpenResty处理请求时会检查HTTP头部的Host字段，只有与server_name匹配的server块才这真正提供服务  \n        location / {\n            ...\n        }\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("location配置")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http {\n    server {\n        listen 80;\n        location [=|~|~*|^~] uri {  # URI必须完全匹配 | 大小写敏感匹配 | 大小写不敏感匹配 | 前缀匹配，匹配URI前半部分即可\n             ...\n        }\n        location /item/  {  # 前缀匹配/item/*\n            ...\n        }\n        location / {    # 匹配任意的URI\n        }\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("blockquote",[a("p",[s._v("在server块里可以配置任意数量的location块，定义Web服务接口。Nginx查找location的顺序没有特殊要求，并不是按照配置文件里的顺序逐个查找，而是所有可能的匹配进行排序，查找最佳匹配的location。")])]),s._v(" "),a("h3",{attrs:{id:"_1-2-2-tcp-udp服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-tcp-udp服务"}},[s._v("#")]),s._v(" 1.2.2. TCP/UDP服务")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("stream {        # stream块，TCP/UDP相关功能\n    server {    # server块，第一个Web服务\n        listen 53;\n    }\n\n    server {    # server块，第二个Web服务\n        listen 520 udp;\n        ...\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("定义TCP、UDP服务同样需要使用server指令，然后再用listen指令确定服务使用的具体端口号。"),a("em",[s._v("但因为TCP/UDP协议里没有Host URI的概念，所以server块里是不能使用server_name和location指令，这是与HTTP服务不同的地方，需要注意")])]),s._v(" "),a("h3",{attrs:{id:"_1-2-3-日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-3-日志"}},[s._v("#")]),s._v(" 1.2.3. 日志")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 使用格式main  使用8KB的缓存，每1s刷新一次\nlog_format main `$remote_addr ...`;\naccess_log /var/logs/openresty/access.log main buffer=8k flush=1s;  \n\nerror_log logs/error.log error;  # 默认存放路径是安装目录下的logs/error.log。 第二个参数是输出日志的级别，高于这个级别的日志才会记录下来  debug|info|notice|warn|error|crit|alert|emerg\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"_1-3-负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-负载均衡"}},[s._v("#")]),s._v(" 1.3. 负载均衡")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http {\n    upstream backend {\n        least_conn;        # 负载均衡策略\n        server 127.0.0.1:80;  # 一台上游服务器\n        server ... weight=3;    # 可以指定多台上游服务器\n        server ... backup;      # 备份用的上游服务器\n        keepalive 32;       # 使用连接池，长连接复用\n    }\n\n    server {\n        listen 8088;\n\n        location /passto {\n            proxy_set_header Host $host;   # 使用变量转发原始请求的host头部\n            proxy_pass http://backend;  # 转发到upstream块定义的服务器集群\n        }\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h2",{attrs:{id:"_1-4-nginx-变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-nginx-变量"}},[s._v("#")]),s._v(" 1.4. Nginx 变量")]),s._v(" "),a("p",[s._v("在HTTP服务里常见的变量(以"),a("code",[s._v("curl 'http://loclhost/index.html??a=1&b=2' -H 'hello: world'")]),s._v(")：")]),s._v(" "),a("ul",[a("li",[s._v("$uri   : /index.html")]),s._v(" "),a("li",[s._v("$args  : a=1&b=2")]),s._v(" "),a("li",[s._v("$arg_a : 1")]),s._v(" "),a("li",[s._v("$arg_b : 2")]),s._v(" "),a("li",[s._v("$http_hello : world")]),s._v(" "),a("li",[s._v("$sent_http_server : openresty/1.13.6.2")]),s._v(" "),a("li",[s._v("$remove_addr      : 127.0.0.1")])]),s._v(" "),a("p",[s._v("Nginx内置的变量很多，也可以使用指自定义变量，最常用的就是set，例如：")]),s._v(" "),a("p",[a("code",[s._v('set $max_size 10000 # 定义变量 $max_size="10000"')])]),s._v(" "),a("h2",{attrs:{id:"_1-5-nginx下lua实现机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-nginx下lua实现机制"}},[s._v("#")]),s._v(" 1.5. Nginx下Lua实现机制")]),s._v(" "),a("h2",{attrs:{id:"_1-6-openresty组成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-openresty组成"}},[s._v("#")]),s._v(" 1.6. OpenResty组成")]),s._v(" "),a("ol",[a("li",[s._v("Nginx")]),s._v(" "),a("li",[s._v("LuaJIT")]),s._v(" "),a("li",[s._v("ngx_lua")]),s._v(" "),a("li",[s._v("stream_lua")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("ngx_iconv     :转换不同的字符集编码")])]),s._v(" "),a("li",[a("p",[s._v("ngx_encrypted     :使用AES-256算法执行简单的加密运算")])]),s._v(" "),a("li",[a("p",[s._v("ngx_echo")])]),s._v(" "),a("li",[a("p",[s._v("ngx_set_misc")])]),s._v(" "),a("li",[a("p",[s._v("ngx_headers_more")])]),s._v(" "),a("li",[a("p",[s._v("ngx_memc      : 支持各种memcached操作")])]),s._v(" "),a("li",[a("p",[s._v("lua_core")])]),s._v(" "),a("li",[a("p",[s._v("lua_cjson")])]),s._v(" "),a("li",[a("p",[s._v("lua_string")])]),s._v(" "),a("li",[a("p",[s._v("lua_upload")])]),s._v(" "),a("li",[a("p",[s._v("lua_redis")])]),s._v(" "),a("li",[a("p",[s._v("lua_memcached")])]),s._v(" "),a("li",[a("p",[s._v("lua_mysql")])]),s._v(" "),a("li",[a("p",[s._v("lua_dns")])]),s._v(" "),a("li",[a("p",[s._v("lua_lrucache")])]),s._v(" "),a("li",[a("p",[s._v("lua_lock")])]),s._v(" "),a("li",[a("p",[s._v("lua_websocket")])]),s._v(" "),a("li",[a("p",[s._v("lua_healthcheck")])]),s._v(" "),a("li",[a("p",[s._v("lua_limit_traffic 使用lu定制更灵活的流量控制策略")])])]),s._v(" "),a("hr"),s._v(" "),a("ul",[a("li",[s._v("opm 类似rpm、npm的包管理工具")]),s._v(" "),a("li",[s._v("resty-cli 以命令行的形式直接执行OpenResty/Lua程序")]),s._v(" "),a("li",[s._v("restydoc 类似man的参考手册")])]),s._v(" "),a("p",[a("img",{attrs:{src:"img/openresty_zucheng.png",alt:"openresty"}})]),s._v(" "),a("h2",{attrs:{id:"_1-7-openresty目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-openresty目录结构"}},[s._v("#")]),s._v(" 1.7. OpenResty目录结构")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("\n├── bin  \n├── luajit\n├── lualib\n├── nginx\n├── pod\n└── site\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"_1-8-组件管理工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-8-组件管理工具"}},[s._v("#")]),s._v(" 1.8. 组件管理工具")]),s._v(" "),a("p",[s._v("opm")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("opm search http\n    get\n    info\n    remove\nopm --install-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt  get xxx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#把xxx组建安装到 /opt 目录下")]),s._v("\nopm --cwd               get xxx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装到当前目录的/resty_modules下")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"_1-9-命令行工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-9-命令行工具"}},[s._v("#")]),s._v(" 1.9. 命令行工具")]),s._v(" "),a("p",[s._v("resty可以当作一个lua解释器来用（但是运行再OpenResty环境里)。")]),s._v(" "),a("p",[s._v("本质上是启动了一个“无服务“的nginx实例，禁用了daemon等大多数指令，也没有配置监听端口，只是在worker进程里用定时器让lua代码在Nginx里执行。")]),s._v(" "),a("p",[s._v("使用"),a("code",[s._v("-e")]),s._v("参数可以在命令行里直接执行lua代码")]),s._v(" "),a("p",[a("code",[s._v("./resty -e \"print('hello world')\"")])]),s._v(" "),a("div",{staticClass:"language-hello.lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#!/opt/openresty/bin/resty\n\nlocal n = #arg\nprint("args count = ", n)\nfor i = 1, n do\n    print("arg ", i, ": ", arg[i])\nend\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("code",[s._v("./hello.lua one two")])]),s._v(" "),a("p",[a("img",{attrs:{src:"img/restycli.png",alt:"resty_cli"}})]),s._v(" "),a("p",[s._v("resty工具常用参数：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("-c "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" 指定最大并发连接数（默认64）\n-I  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" 指定lua库的搜索路径\n-l  ：指定加载某个lua库\n--http-conf "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" 定制在http域里的指令\n--main-include ： 定制在main域里的指令\n--shdict        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" 定制使用的共享内存\n--resolve-ipv6  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" 允许解析ipv6的地址\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"_1-10-restydoc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-10-restydoc"}},[s._v("#")]),s._v(" 1.10. restydoc")]),s._v(" "),a("p",[s._v("openresty的文档，参数 -s 可以用来指定搜索手册里的小节名。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("./restydoc ngx_lua\n./restydoc -s ngx.say\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("opm安装的组件，需要使用-r参数来指定安装目录\n"),a("code",[s._v("./restydoc -r /usr/local/openresty/site -s lua-resty-http")])]),s._v(" "),a("h2",{attrs:{id:"_1-11-ngx-lua"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-11-ngx-lua"}},[s._v("#")]),s._v(" 1.11. ngx_lua")]),s._v(" "),a("p",[s._v("ngx_http_lua_module")]),s._v(" "),a("h3",{attrs:{id:"_1-11-1-配置指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-11-1-配置指令"}},[s._v("#")]),s._v(" 1.11.1. 配置指令")]),s._v(" "),a("ul",[a("li",[s._v("lua_package_path  设置lua脚本的查找路径")]),s._v(" "),a("li",[s._v("lua_package_cpath  设置lua c模块（*.so)的查找路径")]),s._v(" "),a("li",[s._v("lua_code_cache 设置lua代码缓存，加速执行速度")]),s._v(" "),a("li",[s._v("lua_malloc_trim 定期清理内存，减少内存的占用")]),s._v(" "),a("li",[s._v("lua_shared_dict 定义一块共享内存")]),s._v(" "),a("li",[s._v("lua_check_client_about 检测客户端断连")])]),s._v(" "),a("p",[s._v("lua_package_path/lua_package_cpath 以字符串的形式确定lua脚本和库的路径，多个路径用"),a("code",[s._v(";")]),s._v("分隔，默认的查找路径用"),a("code",[s._v(";;")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"_1-11-2-功能指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-11-2-功能指令"}},[s._v("#")]),s._v(" 1.11.2. 功能指令")]),s._v(" "),a("p",[s._v("xxx_by_lua")]),s._v(" "),a("ul",[a("li",[s._v("init_by_lua  在postconfiguration阶段执行lua代码")]),s._v(" "),a("li",[s._v("init_worker_by_lua  在init_process阶段执行lua代码")]),s._v(" "),a("li",[s._v("set_by_lua    在rewerite阶段操作Nginx变量")]),s._v(" "),a("li",[s._v("rewreite_by_lua   在rewrite阶段执行lua代码")]),s._v(" "),a("li",[s._v("access_by_lua    在access阶段执行lua代码")]),s._v(" "),a("li",[s._v("content_by_lua    在content阶段执行lua代码，产生响应内容")]),s._v(" "),a("li",[s._v("header_filter_by_lua  在header_filter阶段执行lua代码")]),s._v(" "),a("li",[s._v("body_filter_by_lua    在body_filter阶段执行lua代码")]),s._v(" "),a("li",[s._v("log_by_lua    在log阶段执行lua代码")]),s._v(" "),a("li",[s._v("balancer_by_lua   在负载均衡阶段执行lua代码")])]),s._v(" "),a("p",[s._v("ngx_lua的功能指令通常都有三种形式")]),s._v(" "),a("ol",[a("li",[s._v("xxx_by_lua        执行指令后字符串形式的lua代码")]),s._v(" "),a("li",[s._v("xxx_by_lua_block  指令后是{...}的lua代码块")]),s._v(" "),a("li",[s._v("xxx_by_lua_file   执行磁盘上的脚本文件 （推荐）")])]),s._v(" "),a("h3",{attrs:{id:"_1-11-3-ngx-lua指令关系图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-11-3-ngx-lua指令关系图"}},[s._v("#")]),s._v(" 1.11.3. ngx_lua指令关系图")]),s._v(" "),a("h3",{attrs:{id:"_1-11-4-应用开发流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-11-4-应用开发流程"}},[s._v("#")]),s._v(" 1.11.4. 应用开发流程")]),s._v(" "),a("ol",[a("li",[s._v("确定对外服务端口（80？）,也就是定义Nginx的server")]),s._v(" "),a("li",[s._v("确定对外服务的URI,也就是定义的Nginx的location")]),s._v(" "),a("li",[s._v("确定执行业务逻辑的一个或多个具体阶段，，如rewrite/access/content等")]),s._v(" "),a("li",[s._v("在location里使用ngx_lua指令，配置基本参数和要执行的脚本")]),s._v(" "),a("li",[s._v("根据需求编写一个或多个lua脚本，实现业务")]),s._v(" "),a("li",[s._v("调试、测试，最后部署上线运行")])]),s._v(" "),a("h2",{attrs:{id:"_1-12-功能接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-功能接口"}},[s._v("#")]),s._v(" 1.12. 功能接口")]),s._v(" "),a("p",[s._v("以下代码的Nginx.cong的配置如下")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("worker_processes  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nerror_log logs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("events")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    worker_connections "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("http")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("server")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8888")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("^")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\\w"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        content_by_lua_file service"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("http"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("$"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.")]),s._v("lua"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"_1-12-1-运行日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-1-运行日志"}},[s._v("#")]),s._v(" 1.12.1. 运行日志")]),s._v(" "),a("p",[s._v("ngx.log(log_level,...)  -- 记录运行日志 logs/errors.log")]),s._v(" "),a("p",[s._v("-- 第一个参数是日志级别 ngx.INFO/ngx.NOTICE/ngx.WARN/ngx.ERROR等")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello openresty"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WARN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"warning is "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"some message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERROR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" debug"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("traceback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_1-12-2-时间与日期"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-2-时间与日期"}},[s._v("#")]),s._v(" 1.12.2. 时间与日期")]),s._v(" "),a("ul",[a("li",[s._v("ngx.sleep  同步非阻塞的睡眠函数，可以来暂停一小段时间")]),s._v(" "),a("li",[s._v("ngx.time  返回当前的时间戳 秒")]),s._v(" "),a("li",[s._v("ngx.now   返回时间，精确到毫秒")]),s._v(" "),a("li",[s._v("ngx.today 当天的日期")]),s._v(" "),a("li",[s._v("ngx.localtime 本地时间")]),s._v(" "),a("li",[s._v("ngx.utctime utc时间")]),s._v(" "),a("li",[s._v("ngx.cookie_time 把时间戳转换为cookie时间格式")]),s._v(" "),a("li",[s._v("ngx.http_time 把时间戳转换为http时间格式")]),s._v(" "),a("li",[s._v("ngx.update_time 强制更新时间，可获得更准确的时间，但成本较高")]),s._v(" "),a("li",[s._v("ngx.parse_http_time 解析http时间，转换为时间戳")])]),s._v(" "),a("p",[a("img",{attrs:{src:"img/ngxtimeanddate.png",alt:""}})]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<h2> Time and Date </h2>"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("update_time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" t1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.time():\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("t1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v("  t2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.now():\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" t2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" d1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("today")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.today():\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" d1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ltime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("localtime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.localtime():\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ltime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" utime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("utctime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.utctime():\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("utime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.cookie_time():\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cookie_time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" httptime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("http_time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.http_time():\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("httptime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ngx.parse_http_time(ngx.http_time()):\\t"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("parse_http_time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("httptime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ffi "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ffi"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ffi_null "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ffi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ffi_null\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ffi_cdef "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ffi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cdef\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ffi_new "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ffi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("new\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ffi_C "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ffi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("C\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ffi_typeof "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ffi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("typeof\nffi_cdef"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("[[\n    struct timeval {\n        long int tv_sec;\n        long int tv_usec;\n    };\n    int gettimeofday(struct timeval *tv, void *tz); // c函数声明\n]]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" timeval_t "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ffi_typeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"struct timeval"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 产生一个C结构的“类型对象”")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" tm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ffi_new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("timeval_t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 分配供C函数使用的内存")]),s._v("\n\nffi_C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("gettimeofday")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ffi_null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tv_sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看数据类型，是cdata")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('-- ngx.say("Sec:",tm.tv_sec) -- error')]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Sec:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tonumber")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tv_sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("h3",{attrs:{id:"_1-12-3-变量-ngx-var"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-3-变量-ngx-var"}},[s._v("#")]),s._v(" 1.12.3. 变量 ngx.var")]),s._v(" "),a("p",[s._v("表ngx.var里包含了所有Nginx内置变量和自定义变量，可以用 "),a("code",[s._v("[]")]),s._v(" 或者 "),a("code",[s._v(".")]),s._v("任意访问，如果变量是可写的，还可以直接修改。")]),s._v(" "),a("p",[a("img",{attrs:{src:"img/ngx_var.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"_1-12-4-正则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-4-正则"}},[s._v("#")]),s._v(" 1.12.4. 正则")]),s._v(" "),a("ul",[a("li",[s._v("ngx.re.matcch")]),s._v(" "),a("li",[s._v("ngx.re.find")]),s._v(" "),a("li",[s._v("ngx.re.gmatch")]),s._v(" "),a("li",[s._v("ngx.e.sub")]),s._v(" "),a("li",[s._v("ngx.re.gsub")])]),s._v(" "),a("p",[s._v("使用这些函数应该尽量使用"),a("code",[s._v("[[...]]")]),s._v("的方式书写正则表达式，避免转义的问题;可以使用 jo 参数启用PCRE JIT编译。")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('-- 参数 "j" 启用 JIT 编译，参数 "o" 是开启缓存必须的')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- sub")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" str "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"abcdab-123ab"')]),s._v("\nstr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("re"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sub")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ab"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cd"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- cdcdab-123ab")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- gsub")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" str "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"abcdab-123ab"')]),s._v("\nstr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("re"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("gsub")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ab"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cd"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- cdcdcd-123cd")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- find")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" to "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("re"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("[[\\d+]]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sub")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("to"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- match")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" regex "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("[[\\d+]]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" m "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("re"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, 1234"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" regex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" m "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 1234")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"not matched!"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- gmatch")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" it"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("re"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("gmatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello12331, wo424rld!as124"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("[[\\d+]]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" it "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("it")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" m "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- no match found (any more)")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- found a match")]),s._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"|"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 12331|nil")]),s._v("\n                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 424|nil")]),s._v("\n                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 124|nil")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("h3",{attrs:{id:"_1-12-5-请求处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-请求处理"}},[s._v("#")]),s._v(" 1.12.5. 请求处理")]),s._v(" "),a("p",[s._v("OpenResty/ngx_lua对http请求的处理提供非常完善的支持，大约有40个接口，可以操作请求行，请求头，请求体，响应头，响应体，执行重定向，跳转等。")]),s._v(" "),a("h4",{attrs:{id:"_1-12-5-1-环境数据-ngx-ctx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-1-环境数据-ngx-ctx"}},[s._v("#")]),s._v(" 1.12.5.1. 环境数据 ngx.ctx")]),s._v(" "),a("p",[s._v("表ngx.ctx是http请求的“环境数据”，相当与nginx中的r->ctx.它是每个请求所独有的，可以用来存储一些临时的数据，在整个处理流程中共享。")]),s._v(" "),a("p",[s._v("但是ngx.ctx使用成本较高，应当尽量少用。")]),s._v(" "),a("h4",{attrs:{id:"_1-12-5-2-请求行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-2-请求行"}},[s._v("#")]),s._v(" 1.12.5.2. 请求行")]),s._v(" "),a("ul",[a("li",[s._v("start_time    请求的开始时间，相当于$request_time")]),s._v(" "),a("li",[s._v("get_method    获取字符串形式的的请求参数")]),s._v(" "),a("li",[s._v("set_method    改写请求方法，使用数字常量，不能用字符串")]),s._v(" "),a("li",[s._v("set_uri       改写URI")]),s._v(" "),a("li",[s._v("get_uri_args  获取URI的参数，以表的形式返回解析后的结果")]),s._v(" "),a("li",[s._v("get_post_args 获取POST方式传递的参数，同样返回一个表")]),s._v(" "),a("li",[s._v("set_uri_args  改写URI参数")])]),s._v(" "),a("p",[s._v("这些函数可以用rewrite阶段，改写URI的各种参数，实现跳转。")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" arg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_uri_args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("v "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pairs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("arg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[GET] key:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" v:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 解析 body 参数之前一定要先读取 body")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" arg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_post_args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("v "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pairs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("arg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[POST] key:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" v:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[a("img",{attrs:{src:"img/get_post_args.png",alt:""}})]),s._v(" "),a("h4",{attrs:{id:"_1-12-5-3-请求头"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-3-请求头"}},[s._v("#")]),s._v(" 1.12.5.3. 请求头")]),s._v(" "),a("ul",[a("li",[s._v("raw_header    获取请求头的未解析字符串")]),s._v(" "),a("li",[s._v("get_headers   获取所有的HTTP请求头，返回一个表")]),s._v(" "),a("li",[s._v("set_header    改写一个HTTP请求头")]),s._v(" "),a("li",[s._v("clear_header  删除一个HTTP请求头")])]),s._v(" "),a("p",[s._v("http的请求头都是Key-Value的形式，很适合用Lua里的表来存储，处理请求头的接口;后两个函数通常用在rewrite阶段，改写HTTP请求。")]),s._v(" "),a("h4",{attrs:{id:"_1-12-5-4-请求体"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-4-请求体"}},[s._v("#")]),s._v(" 1.12.5.4. 请求体")]),s._v(" "),a("ul",[a("li",[s._v("discard_body  丢弃请求体")]),s._v(" "),a("li",[s._v("read_body     开始读取请求体的内容")]),s._v(" "),a("li",[s._v("get_body_data 获取请求体参数，是非阻塞的")]),s._v(" "),a("li",[s._v("set_body_data 改写请求体数据")]),s._v(" "),a("li",[s._v("get_body_file 如果请求体很大，存储在文件里，返回使用的文件名")]),s._v(" "),a("li",[s._v("set_body_file 把请求体数据写入文件，文件必须已经存在")]),s._v(" "),a("li",[s._v("init_body     创建一个新的请求体替代原请求的数据")]),s._v(" "),a("li",[s._v("append_body   向init_body创建的请求体里添加数据")]),s._v(" "),a("li",[s._v("finish_body   完成请求体数据的创建")])]),s._v(" "),a("h4",{attrs:{id:"_1-12-5-5-响应头"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-5-响应头"}},[s._v("#")]),s._v(" 1.12.5.5. 响应头")]),s._v(" "),a("ul",[a("li",[s._v("ngx.status    读取响应状态码")]),s._v(" "),a("li",[s._v("ngx.header    读写响应")]),s._v(" "),a("li",[s._v("ngx.send_headers  发送响应头，是非阻塞的")]),s._v(" "),a("li",[s._v("ngx.headerrs_sent 检查响应头是否已经发送")])]),s._v(" "),a("p",[a("code",[s._v("ngx.header.content_length = len -- 相当于header['Content-Length']")])]),s._v(" "),a("h4",{attrs:{id:"_1-12-5-6-响应体"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-6-响应体"}},[s._v("#")]),s._v(" 1.12.5.6. 响应体")]),s._v(" "),a("ul",[a("li",[s._v("ngx.print")]),s._v(" "),a("li",[s._v("ngx.say")]),s._v(" "),a("li",[s._v("ngx.flush")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- ngx.var.limit_rate = 1024*1024")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"data.db"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"r"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" file "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n            ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"open file error:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("HTTP_SERVICE_UNAVAILABLE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" data\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n            data "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" data "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n            ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("flush")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n        file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h4",{attrs:{id:"_1-12-5-7-流程控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-5-7-流程控制"}},[s._v("#")]),s._v(" 1.12.5.7. 流程控制")]),s._v(" "),a("ul",[a("li",[s._v("ngx.exit  立即结束请求的处理，返回的状态码可以用参数指定")]),s._v(" "),a("li",[s._v("ngx.eof   结束发送响应数据，但可以继续执行后面的储量逻辑")]),s._v(" "),a("li",[s._v("ngx.exec  执行server内部的location跳转")]),s._v(" "),a("li",[s._v("ngx.redirect 执行标准的301/302重定向")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("^")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("static"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("_a"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("zA"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Z0"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("jpg")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    set $image_name $"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/download_internal/images/"')]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("var"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("image_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".jpg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("download_internal")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    internal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 这里还可以有其他统一的 download 下载设置，例如限速等\n    alias "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("download"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("foo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("[[I am foo]]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rewrite_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("redirect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/foo'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"_1-12-6-请求转发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-6-请求转发"}},[s._v("#")]),s._v(" 1.12.6. 请求转发")]),s._v(" "),a("p",[s._v("corountine based socket功能以同步非阻塞的方式实现socket编程，高效地与任意后端服务通信。")]),s._v(" "),a("p",[s._v("内建连接池，实现长连接")]),s._v(" "),a("p",[s._v("支持tcp udp UNIX Domain Socket")]),s._v(" "),a("p",[s._v("函数 ngx.socket.tcp() 创建一个tcp协议的cosocket对象，能够与任意的TCP服务器通信，可以使用的方法有：")]),s._v(" "),a("ul",[a("li",[s._v("settimeout    设置tcp通信的超时时间")]),s._v(" "),a("li",[s._v("settimeouts   分别设置建立连接/读/写的超时时间")]),s._v(" "),a("li",[s._v("connect       建立有后端服务器连接")]),s._v(" "),a("li",[s._v("sslhandshake  发起SSL/TLS握手")]),s._v(" "),a("li",[s._v("send          发送数据")]),s._v(" "),a("li",[s._v("receive       接收数据")]),s._v(" "),a("li",[s._v("receiveuntil  以指定的模式持续接收数据")]),s._v(" "),a("li",[s._v("close         关闭连接")]),s._v(" "),a("li",[s._v("setkeepalive  把连接放入连接池，即长连接复用")])]),s._v(" "),a("p",[s._v("ngx.socket.connect() 相当于ngx.socket.tcp()后紧接着调用connect(),返回一个已经成功创建连接的cosocket对象（tcp)")]),s._v(" "),a("h3",{attrs:{id:"_1-12-7-子请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-7-子请求"}},[s._v("#")]),s._v(" 1.12.7. 子请求")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    internal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_uri_args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tonumber")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tonumber")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("subduction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    internal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_uri_args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tonumber")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tonumber")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("test_parallels")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" start_time "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("location"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("capture_multi")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sum"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/subduction"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" response:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" response:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time used:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" start_time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nlocation "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("test_queue")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("content_by_lua_block")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" start_time "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("location"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("capture_multi")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sum"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("location"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("capture_multi")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/subduction"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" response:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" response:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time used:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" start_time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- ➜  ~ curl 127.0.0.1/app/test_parallels")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- status:200 response:11")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- status:200 response:-5")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- time used:0.10099983215332")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- ➜  ~ curl 127.0.0.1/app/test_queue")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- status:200 response:11")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- status:200 response:-5")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- time used:0.20199990272522")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br")])]),a("h3",{attrs:{id:"_1-12-8-定时器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-8-定时器"}},[s._v("#")]),s._v(" 1.12.8. 定时器")]),s._v(" "),a("p",[s._v("定时器handler的执行是与HTTP请求处理分离的，所以在函数里不能使用ngx.var、ngx.say、ngx.print等请求相关的函数。")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" delay "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 5s， 如果用毫秒可以用小数来指定")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" handler\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- do some routine job in Lua just like a cron job")]),s._v("\nhandler "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("premature"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" premature "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 第一个参数必须是premature，函数可以由此判断Nginx worker进程是否正在退出，执行必要的清理动作")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("timer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("delay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" handler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to create the timer: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("timer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("delay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" handler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" ok "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ERR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to create the timer: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h3",{attrs:{id:"_1-12-9-共享内存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-12-9-共享内存"}},[s._v("#")]),s._v(" 1.12.9. 共享内存")]),s._v(" "),a("p",[s._v("ngx_lua的指令lua_shared_dict定义共享内存，格式如下(只能在http{}里使用)：")]),s._v(" "),a("p",[a("code",[s._v("lua_shared_dict shm_name size # 定义一个大小为size名为shm_name的共享内存")])]),s._v(" "),a("p",[a("code",[s._v("lua_shared_dict stats 32m # 定义一个32m的共享内存")])]),s._v(" "),a("ul",[a("li",[s._v("get           从共享内存里获取一个值")]),s._v(" "),a("li",[s._v("set           向共享内存里写入一个值，可以设置过期时间")]),s._v(" "),a("li",[s._v("add           类似set,但只有key不存在时才可以写入")]),s._v(" "),a("li",[s._v("replace       与add相反，不存在时才写入（替换？)")]),s._v(" "),a("li",[s._v("delete        删除共享内存里的一个key")]),s._v(" "),a("li",[s._v("incr          原子递增整数")]),s._v(" "),a("li",[s._v("lpush/rpush   队列操作，在两端添加数据")]),s._v(" "),a("li",[s._v("lpop/rpop     队列操作，在两端删除数据")]),s._v(" "),a("li",[s._v("llen          获得队列里的元素数量")]),s._v(" "),a("li",[s._v("flush_all     清空共享内存里的所有数据")]),s._v(" "),a("li",[s._v("flush_expired 清空共享内存里所有过期数据")])]),s._v(" "),a("p",[s._v("ngx_lua的这个共享内存功能非常有用，极大的便利了worker进程间的通信和协作。")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" stats "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stats  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 获取之前定义的共享内存对象")]),s._v("\n\nstats"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"count"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在共享内存里设置一个值 count = 1， 10s后过期")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" v "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" stats"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"count"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 获取共享内存里的值")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" stats"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("incr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uid"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 原子增加一个整数")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nstats"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpush")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sessions"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxx123xxx123xxx"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 队列操作，在右端插入一个元素")]),s._v("\nv "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" stats"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("lpop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sessions"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 队列操作，从左端取出一个元素")]),s._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nstats"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("flush_all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 清空共享内存里的所有数据")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);