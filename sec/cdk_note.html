<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hot</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="安全开发工程师(打杂工程师)的学习笔记">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.c319bac8.js" as="script"><link rel="preload" href="/assets/js/2.ee734a59.js" as="script"><link rel="preload" href="/assets/js/126.5632c4d7.js" as="script"><link rel="prefetch" href="/assets/js/10.9841cdef.js"><link rel="prefetch" href="/assets/js/100.98c51b8e.js"><link rel="prefetch" href="/assets/js/101.80ca1839.js"><link rel="prefetch" href="/assets/js/102.1c33cf56.js"><link rel="prefetch" href="/assets/js/103.b0b93725.js"><link rel="prefetch" href="/assets/js/104.c0c62484.js"><link rel="prefetch" href="/assets/js/105.1134daba.js"><link rel="prefetch" href="/assets/js/106.f9a27c7b.js"><link rel="prefetch" href="/assets/js/107.d3560c2c.js"><link rel="prefetch" href="/assets/js/108.dc824726.js"><link rel="prefetch" href="/assets/js/109.56b97cf6.js"><link rel="prefetch" href="/assets/js/11.8bb5db91.js"><link rel="prefetch" href="/assets/js/110.9893b030.js"><link rel="prefetch" href="/assets/js/111.53623519.js"><link rel="prefetch" href="/assets/js/112.e5269575.js"><link rel="prefetch" href="/assets/js/113.2a3d6326.js"><link rel="prefetch" href="/assets/js/114.f28d91ec.js"><link rel="prefetch" href="/assets/js/115.4219f56e.js"><link rel="prefetch" href="/assets/js/116.2f15c358.js"><link rel="prefetch" href="/assets/js/117.7e79e8c3.js"><link rel="prefetch" href="/assets/js/118.cd0ccb4e.js"><link rel="prefetch" href="/assets/js/119.1a8f3bb4.js"><link rel="prefetch" href="/assets/js/12.c3457dbf.js"><link rel="prefetch" href="/assets/js/120.22b3dd05.js"><link rel="prefetch" href="/assets/js/121.48115499.js"><link rel="prefetch" href="/assets/js/122.49df4874.js"><link rel="prefetch" href="/assets/js/123.bb366ac5.js"><link rel="prefetch" href="/assets/js/124.a1091dce.js"><link rel="prefetch" href="/assets/js/125.cba9e1c7.js"><link rel="prefetch" href="/assets/js/127.83f20d12.js"><link rel="prefetch" href="/assets/js/128.df2f79c7.js"><link rel="prefetch" href="/assets/js/129.714ec10b.js"><link rel="prefetch" href="/assets/js/13.5a5564aa.js"><link rel="prefetch" href="/assets/js/130.f648ae53.js"><link rel="prefetch" href="/assets/js/14.31b1fb86.js"><link rel="prefetch" href="/assets/js/15.1f1a4999.js"><link rel="prefetch" href="/assets/js/16.2445c170.js"><link rel="prefetch" href="/assets/js/17.00149ca9.js"><link rel="prefetch" href="/assets/js/18.14f17999.js"><link rel="prefetch" href="/assets/js/19.4dfbf270.js"><link rel="prefetch" href="/assets/js/20.4f419716.js"><link rel="prefetch" href="/assets/js/21.04f10048.js"><link rel="prefetch" href="/assets/js/22.d5ea4ea8.js"><link rel="prefetch" href="/assets/js/23.2da0cb4d.js"><link rel="prefetch" href="/assets/js/24.171bad48.js"><link rel="prefetch" href="/assets/js/25.c648bffe.js"><link rel="prefetch" href="/assets/js/26.f7412ad6.js"><link rel="prefetch" href="/assets/js/27.3358de23.js"><link rel="prefetch" href="/assets/js/28.f4a4badf.js"><link rel="prefetch" href="/assets/js/29.5581c8fb.js"><link rel="prefetch" href="/assets/js/3.208249f8.js"><link rel="prefetch" href="/assets/js/30.4f07acfb.js"><link rel="prefetch" href="/assets/js/31.ad87b1d0.js"><link rel="prefetch" href="/assets/js/32.218c7530.js"><link rel="prefetch" href="/assets/js/33.06ce8d5f.js"><link rel="prefetch" href="/assets/js/34.e645d5f9.js"><link rel="prefetch" href="/assets/js/35.d3c03632.js"><link rel="prefetch" href="/assets/js/36.3b7139b6.js"><link rel="prefetch" href="/assets/js/37.9d30b16f.js"><link rel="prefetch" href="/assets/js/38.37e19265.js"><link rel="prefetch" href="/assets/js/39.a7a5a417.js"><link rel="prefetch" href="/assets/js/4.2ecfd9d7.js"><link rel="prefetch" href="/assets/js/40.8bd9d455.js"><link rel="prefetch" href="/assets/js/41.6a059dcc.js"><link rel="prefetch" href="/assets/js/42.e2361cae.js"><link rel="prefetch" href="/assets/js/43.7101e1e6.js"><link rel="prefetch" href="/assets/js/44.d8df0a7a.js"><link rel="prefetch" href="/assets/js/45.7b4583e6.js"><link rel="prefetch" href="/assets/js/46.6cf5ac92.js"><link rel="prefetch" href="/assets/js/47.ffd093f8.js"><link rel="prefetch" href="/assets/js/48.f69288ff.js"><link rel="prefetch" href="/assets/js/49.006a40a0.js"><link rel="prefetch" href="/assets/js/5.20014036.js"><link rel="prefetch" href="/assets/js/50.2a75a383.js"><link rel="prefetch" href="/assets/js/51.192e7cb9.js"><link rel="prefetch" href="/assets/js/52.cc5ea856.js"><link rel="prefetch" href="/assets/js/53.b963fae3.js"><link rel="prefetch" href="/assets/js/54.1e75d52b.js"><link rel="prefetch" href="/assets/js/55.aaf95197.js"><link rel="prefetch" href="/assets/js/56.b57fb18c.js"><link rel="prefetch" href="/assets/js/57.d6ec3a28.js"><link rel="prefetch" href="/assets/js/58.a59a2bb3.js"><link rel="prefetch" href="/assets/js/59.2fd766d2.js"><link rel="prefetch" href="/assets/js/6.1aac11ee.js"><link rel="prefetch" href="/assets/js/60.9e6636d0.js"><link rel="prefetch" href="/assets/js/61.83fb732b.js"><link rel="prefetch" href="/assets/js/62.4ade8f03.js"><link rel="prefetch" href="/assets/js/63.bc5bd52e.js"><link rel="prefetch" href="/assets/js/64.0ee3dd03.js"><link rel="prefetch" href="/assets/js/65.ef7b2f39.js"><link rel="prefetch" href="/assets/js/66.c4321bd0.js"><link rel="prefetch" href="/assets/js/67.d0758688.js"><link rel="prefetch" href="/assets/js/68.014193b5.js"><link rel="prefetch" href="/assets/js/69.a6114edb.js"><link rel="prefetch" href="/assets/js/7.1848bf21.js"><link rel="prefetch" href="/assets/js/70.e685c54f.js"><link rel="prefetch" href="/assets/js/71.504c2b6b.js"><link rel="prefetch" href="/assets/js/72.4c7505ad.js"><link rel="prefetch" href="/assets/js/73.6790e908.js"><link rel="prefetch" href="/assets/js/74.71d69108.js"><link rel="prefetch" href="/assets/js/75.72af672f.js"><link rel="prefetch" href="/assets/js/76.c4a9226c.js"><link rel="prefetch" href="/assets/js/77.d38a498d.js"><link rel="prefetch" href="/assets/js/78.871d750a.js"><link rel="prefetch" href="/assets/js/79.527e7a49.js"><link rel="prefetch" href="/assets/js/8.8534ef4e.js"><link rel="prefetch" href="/assets/js/80.715f442a.js"><link rel="prefetch" href="/assets/js/81.74a2b8bd.js"><link rel="prefetch" href="/assets/js/82.066897b9.js"><link rel="prefetch" href="/assets/js/83.c264466b.js"><link rel="prefetch" href="/assets/js/84.18734103.js"><link rel="prefetch" href="/assets/js/85.afd2f665.js"><link rel="prefetch" href="/assets/js/86.073fdd24.js"><link rel="prefetch" href="/assets/js/87.29303003.js"><link rel="prefetch" href="/assets/js/88.d3d4f30c.js"><link rel="prefetch" href="/assets/js/89.56c3e387.js"><link rel="prefetch" href="/assets/js/9.73e739d0.js"><link rel="prefetch" href="/assets/js/90.022513aa.js"><link rel="prefetch" href="/assets/js/91.3cece5cd.js"><link rel="prefetch" href="/assets/js/92.1f9fa6f9.js"><link rel="prefetch" href="/assets/js/93.35733127.js"><link rel="prefetch" href="/assets/js/94.71526dfb.js"><link rel="prefetch" href="/assets/js/95.eff5cd3e.js"><link rel="prefetch" href="/assets/js/96.a30824e0.js"><link rel="prefetch" href="/assets/js/97.1e11427f.js"><link rel="prefetch" href="/assets/js/98.522292bb.js"><link rel="prefetch" href="/assets/js/99.6bf29dfd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Hot</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sec/" class="nav-link router-link-active">
  安全
</a></div><div class="nav-item"><a href="/dev/" class="nav-link">
  开发
</a></div><div class="nav-item"><a href="/ops/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  杂记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zmf963/showip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  show ip
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/subdomain" target="_blank" rel="noopener noreferrer" class="nav-link external">
  subdomain
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/hotfinger" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hotfinger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/HotSec" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sec/" class="nav-link router-link-active">
  安全
</a></div><div class="nav-item"><a href="/dev/" class="nav-link">
  开发
</a></div><div class="nav-item"><a href="/ops/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  杂记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zmf963/showip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  show ip
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/subdomain" target="_blank" rel="noopener noreferrer" class="nav-link external">
  subdomain
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/hotfinger" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hotfinger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/HotSec" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cdk"><a href="#cdk" class="header-anchor">#</a> CDK</h1> <ul><li><p><a href="#1-%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8C">1. 编译运行</a></p></li> <li><p><a href="#2-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">2. 目录结构</a></p></li> <li><p><a href="#3-%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3-main">3. 程序入口 main()</a></p></li> <li><p><a href="#4-cli">4. cli</a></p></li> <li><p><a href="#5-evaluate">5. evaluate</a></p> <ul><li><p><a href="#51-callbasics">5.1. CallBasics()</a></p></li> <li><p><a href="#52-calladdedfunc">5.2. CallAddedFunc()</a></p> <ul><li><a href="#521-searchlocalfilepath">5.2.1. SearchLocalFilePath()</a></li> <li><a href="#522-aslr">5.2.2. ASLR()</a></li> <li><a href="#523-dumpcgroup">5.2.3. DumpCgroup()</a></li></ul></li></ul></li> <li><p><a href="#6-exploit">6. exploit</a></p> <ul><li><p><a href="#61-%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90">6.1. 参数解析</a></p></li> <li><p><a href="#62-%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91">6.2. 执行逻辑</a></p></li> <li><p><a href="#63-cdk-run---list--%E6%9F%A5%E7%9C%8Bexp%E5%88%97%E8%A1%A8-total-32">6.3. cdk run --list  查看exp列表 (total 32)</a></p></li> <li><p><a href="#64-cdk-run-poc1-args1">6.4. cdk run poc1 args1</a></p> <ul><li><a href="#641-abuse-unpriv-userns">6.4.1. abuse-unpriv-userns</a></li> <li><a href="#642-ak-leakage">6.4.2. ak-leakage</a></li> <li><a href="#643-cap-dac-read-search">6.4.3. cap-dac-read-search</a></li> <li><a href="#644-check-ptrace">6.4.4. check-ptrace</a></li> <li><a href="#645-docker-api-pwn">6.4.5. docker-api-pwn</a></li> <li><a href="#646-docker-sock-check">6.4.6. docker-sock-check</a></li> <li><a href="#647-docker-sock-pwn">6.4.7. docker-sock-pwn</a></li> <li><a href="#648-etcd-get-k8s-token">6.4.8. etcd-get-k8s-token</a></li> <li><a href="#649-istio-check">6.4.9. istio-Check</a></li> <li><a href="#6410-k8s-backdoor-daemonset">6.4.10. k8s-backdoor-daemonset</a></li> <li><a href="#6411-k8s-configmap-dump">6.4.11. k8s-configmap-dump</a></li> <li><a href="#6412-k8s-cronjob">6.4.12. k8s-cronjob</a></li> <li><a href="#6413-k8s-get-sa-token">6.4.13. k8s-get-sa-token</a></li> <li><a href="#6414-k8s-kubelet-var-log-escape">6.4.14. k8s-kubelet-var-log-escape</a></li> <li><a href="#6415-k8s-mitm-clusterip">6.4.15. k8s-mitm-clusterip</a></li> <li><a href="#6416-k8s-psp-dump">6.4.16. k8s-psp-dump</a></li> <li><a href="#6417-k8s-secret-dump">6.4.17. k8s-secret-dump</a></li> <li><a href="#6418-k8s-shadow-apiserver">6.4.18. k8s-shadow-apiserver</a></li> <li><a href="#6419-kubelet-exec">6.4.19. kubelet-exec</a></li> <li><a href="#6420-lxcfs-rw">6.4.20. lxcfs-rw</a></li> <li><a href="#6421-lxcfs-rw-cgroup">6.4.21. lxcfs-rw-cgroup</a></li> <li><a href="#6422-mount-cgroup">6.4.22. mount-cgroup</a></li> <li><a href="#6423-mount-disk">6.4.23. mount-disk</a></li> <li><a href="#6424-mount-procfs">6.4.24. mount-procfs</a></li> <li><a href="#6425-registry-brute">6.4.25. registry-brute</a></li> <li><a href="#6426-reverse-shell">6.4.26. reverse-shell</a></li> <li><a href="#6427-rewrite-cgroup-devices">6.4.27. rewrite-cgroup-devices</a></li> <li><a href="#6428-runc-pwn">6.4.28. runc-pwn</a></li> <li><a href="#6429-service-probe">6.4.29. service-probe</a></li> <li><a href="#6430-shim-pwn">6.4.30. shim-pwn</a></li> <li><a href="#6431-webshell-deploy">6.4.31. webshell-deploy</a></li></ul></li></ul></li> <li><p><a href="#7-tool-%E9%83%A8%E5%88%86">7. tool 部分</a></p></li> <li><p><a href="#8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">8. 参考资料</a></p></li></ul> <h2 id="_1-编译运行"><a href="#_1-编译运行" class="header-anchor">#</a> 1. 编译运行</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
gitclonehttps://github.com/cdk-team/CDK/

cdCDK

gobuildcmd/cdk/cdk.go

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_2-目录结构"><a href="#_2-目录结构" class="header-anchor">#</a> 2. 目录结构</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
├──cmd

│   └──cdk  //入口函数

├──conf

├──go.mod

├──go.sum

├──LICENSE

├──pkg

│   ├──cli  //命令行参数解析

│   ├──errors  //自定义CDKRuntimeError

│   ├──evaluate//本地信息收集

│   ├──exploit  //exp

│   ├──plugin  //插件管理接口

│   ├──task   //自动逃逸代码

│   ├──tool  //工具集ncviifconfigpscurl端口扫描等

│   └──util  //一些功能函数

├──README.md

├──test

│   ├──CDK-deploy-test

│   ├──k8s_exploit_util

│   ├──scan_file_path

│   └──scan_file_text

└──thanks.md

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>一共大约 8000 行代码，需要重点关注启动 pkg 下面的 6000 行代码。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
     134textfiles.

     132uniquefiles.

      15filesignored.


github.com/AlDanial/clocv1.74  <span class="token assign-left variable">T</span><span class="token operator">=</span><span class="token number">0</span>.29s <span class="token punctuation">(</span><span class="token number">416.0</span> files/s,40163.5lines/s<span class="token punctuation">)</span>

-------------------------------------------------------------------------------

Language                     files          blank        comment           code

-------------------------------------------------------------------------------

Go                              <span class="token number">95</span>           <span class="token number">1614</span>           <span class="token number">1923</span>           <span class="token number">6396</span>

Python                           <span class="token number">6</span>            <span class="token number">127</span>            <span class="token number">102</span>            <span class="token number">859</span>

Markdown                         <span class="token number">5</span>            <span class="token number">110</span>              <span class="token number">0</span>            <span class="token number">274</span>

YAML                            <span class="token number">11</span>             <span class="token number">24</span>              <span class="token number">8</span>            <span class="token number">253</span>

BourneShell                     <span class="token number">1</span>             <span class="token number">20</span>              <span class="token number">6</span>             <span class="token number">41</span>

JSON                             <span class="token number">4</span>              <span class="token number">0</span>              <span class="token number">0</span>             <span class="token number">23</span>

-------------------------------------------------------------------------------

SUM:                           <span class="token number">122</span>           <span class="token number">1895</span>           <span class="token number">2039</span>           <span class="token number">7846</span>

-------------------------------------------------------------------------------

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="_3-程序入口-main"><a href="#_3-程序入口-main" class="header-anchor">#</a> 3. 程序入口 main()</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
<span class="token function">funcmain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    cli<span class="token punctuation">.</span><span class="token function">ParseCDKMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_4-cli"><a href="#_4-cli" class="header-anchor">#</a> 4. cli</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>
cmd/cdk/cdk.go --&gt; main() --&gt; cli.ParseCDKMain()


docopt/docopt-go 命令行参数解析

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_5-evaluate"><a href="#_5-evaluate" class="header-anchor">#</a> 5. evaluate</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
    <span class="token keyword">if</span> ok<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">||</span> fok<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>BannerHeader<span class="token punctuation">)</span>

        evaluate<span class="token punctuation">.</span><span class="token function">CallBasics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> Args<span class="token punctuation">[</span><span class="token string">&quot;--full&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            evaluate<span class="token punctuation">.</span><span class="token function">CallAddedFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>

        returntrue

    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_5-1-callbasics"><a href="#_5-1-callbasics" class="header-anchor">#</a> 5.1. CallBasics()</h3> <ul><li><p>BasicSysInfo()</p> <ul><li>os.Getwd()</li> <li>os/user.Current()</li> <li>os.Hostname()</li> <li>gopsutil/v3/host.KernelVersion()</li></ul></li> <li><p>FindSidFiles()</p> <ul><li>find /bin/. -perm -4000 -type f 查找具有 suid 权限的文件</li></ul></li> <li><p>SearchSensitiveEnv()</p> <ul><li>查找有用的环境变量</li> <li>os.Environ()</li> <li>regexp.MatchString(conf.SensitiveEnvRegex, env)</li></ul></li> <li><p>SearchSensitiveService()</p> <ul><li>查找有用的环境进程</li> <li>gops.Processes()</li> <li>regexp.MatchString(conf.SensitiveProcessRegex, proc.Executable())</li></ul></li> <li><p>SearchAvailableCommands()</p> <ul><li>检查命令是否存在</li> <li>exec.LookPath(cmd)</li></ul></li> <li><p>GetProcCapabilities()</p> <ul><li>获取进程的 Capabilities 信息, 获取进程的权限</li> <li>/proc/self/status</li> <li>strings.HasPrefix(line, &quot;Cap&quot;)</li> <li>pattern.FindStringSubmatch(string(data))</li></ul></li> <li><p>MountEscape()</p> <ul><li>获取文件系统挂载信息</li> <li>cat /proc/self/mountinfo</li></ul></li> <li><p>CheckNetNamespace()</p> <ul><li>匹配敏感的 unix 套接字</li> <li>cat /proc/net/unix</li></ul></li> <li><p>CheckRouteLocalNetworkValue()</p> <ul><li>检查网络设备转发 lo 设备数据包的功能</li> <li>cat /proc/sys/net/ipv4/conf/all/route_localnet</li></ul></li> <li><p>CheckK8sAnonymousLogin()</p> <ul><li>检查 api-server 是否允许匿名请求</li> <li>kubectl.ServerAccountRequest</li></ul></li> <li><p>CheckPrivilegedK8sServiceAccount(conf.K8sSATokenDefaultPath)</p> <ul><li>检查服务账户是否可用 kubectl.ServerAccountRequest</li> <li>如果可用会尝试列出 namespaces kubectl.ServerAccountRequest</li></ul></li> <li><p>CheckCloudMetadataAPI()</p> <ul><li>请求 conf.CloudAPI 获取 Metadata API 信息</li></ul></li> <li><p>DNSBasedServiceDiscovery()</p> <ul><li>net.LookupSRV</li> <li>基于 dns 进行服务发现 <code>https://github.com/kubernetes/dns/blob/master/docs/specification.md</code></li></ul></li></ul> <h3 id="_5-2-calladdedfunc"><a href="#_5-2-calladdedfunc" class="header-anchor">#</a> 5.2. CallAddedFunc()</h3> <h4 id="_5-2-1-searchlocalfilepath"><a href="#_5-2-1-searchlocalfilepath" class="header-anchor">#</a> 5.2.1. SearchLocalFilePath()</h4> <p>遍历本地文件，查找是否有在 sensitiveFileRules.NameList 里的文件</p> <p>SearchLocalFilePath() -&gt; filepath.Walk() -&gt; strings.Contains()</p> <h4 id="_5-2-2-aslr"><a href="#_5-2-2-aslr" class="header-anchor">#</a> 5.2.2. ASLR()</h4> <p>检查栈随机化是否开启; <code>/proc/sys/kernel/randomize_va_space == 0</code></p> <h4 id="_5-2-3-dumpcgroup"><a href="#_5-2-3-dumpcgroup" class="header-anchor">#</a> 5.2.3. DumpCgroup()</h4> <p>获取进程(1 与 self)的 cgroup 信息 <code>/proc/1/cgroup``/proc/self/cgroup</code></p> <p>util.GetCgroup()</p> <h2 id="_6-exploit"><a href="#_6-exploit" class="header-anchor">#</a> 6. exploit</h2> <h3 id="_6-1-参数解析"><a href="#_6-1-参数解析" class="header-anchor">#</a> 6.1. 参数解析</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
    <span class="token keyword">if</span> Args<span class="token punctuation">[</span><span class="token string">&quot;run&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> Args<span class="token punctuation">[</span><span class="token string">&quot;--list&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// cdk run --list 查看所有的exp</span>

            plugin<span class="token punctuation">.</span><span class="token function">ListAllExploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 列出所有的exp</span>

            os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>

        name <span class="token operator">:=</span> Args<span class="token punctuation">[</span><span class="token string">&quot;&lt;exploit&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> plugin<span class="token punctuation">.</span>Exploits<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>

            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nInvalid script name: %s , available scripts:\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

            plugin<span class="token punctuation">.</span><span class="token function">ListAllExploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            returntrue

        <span class="token punctuation">}</span>

        plugin<span class="token punctuation">.</span><span class="token function">RunSingleExploit</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token comment">// 执行对应的exp</span>

        returntrue

    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_6-2-执行逻辑"><a href="#_6-2-执行逻辑" class="header-anchor">#</a> 6.2. 执行逻辑</h3> <ul><li><p>plugin下定义了Exploits的全局变量用来保存exp信息。</p></li> <li><p>exploit下的exp中的init()函数调用plugin.RegisterExploit(&quot;xxx&quot;, exploit)注册exp到Exploits中</p></li> <li><p>以docker_runc.go为例</p> <ul><li><p>init()</p></li> <li><p>dockerRuncPwnS 接口</p> <ul><li>Desc() 返回exp的说明</li> <li>Run() 执行exp</li></ul></li> <li><p>dockerRuncPwn(hijackCommand string) 最终的漏洞检测函数</p></li></ul></li></ul> <h3 id="_6-3-cdk-run-list-查看exp列表-total-32"><a href="#_6-3-cdk-run-list-查看exp列表-total-32" class="header-anchor">#</a> 6.3. cdk run --list  查看exp列表 (total 32)</h3> <h3 id="_6-4-cdk-run-poc1-args1"><a href="#_6-4-cdk-run-poc1-args1" class="header-anchor">#</a> 6.4. cdk run poc1 args1</h3> <h4 id="_6-4-1-abuse-unpriv-userns"><a href="#_6-4-1-abuse-unpriv-userns" class="header-anchor">#</a> 6.4.1. abuse-unpriv-userns</h4> <p>利用 CVE-2022-0492 进行自动化逃逸。</p> <blockquote><p><a href="https://github.com/cdk-team/CDK/wiki/Exploit:-abuse-unpriv-userns" target="_blank" rel="noopener noreferrer">Exploit: abuse unpriv userns<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <blockquote><p><a href="https://nosec.org/home/detail/4973.html" target="_blank" rel="noopener noreferrer">深入分析CVE-2022-0492漏洞<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="_6-4-2-ak-leakage"><a href="#_6-4-2-ak-leakage" class="header-anchor">#</a> 6.4.2. ak-leakage</h4> <ul><li>查找本地泄漏的Ak/Secrets等敏感信息</li> <li>usage: cdk run ak-leakage <code>&lt;dir&gt;</code></li> <li>Run() -&gt; SearchLocalFileText(path) -&gt; filepath.Walk() -&gt; FindAllStringSubmatch</li></ul> <h4 id="_6-4-3-cap-dac-read-search"><a href="#_6-4-3-cap-dac-read-search" class="header-anchor">#</a> 6.4.3. cap-dac-read-search</h4> <ul><li>CAP_DAC_READ_SEARCH 能够绕过文件的读权限检查和目录的读和执行权限检查；</li> <li>RUN() -&gt; CapDacReadSearchExploit(target, ref, chroot, cmd) -&gt; execCommand(cmd)</li></ul> <p>-<code>docker run -it --rm --cap-add CAP_DAC_READ_SEARCH -v &quot;$(pwd)/cdk&quot;:/cdk ubuntu /bin/bash``cdk run cap-dac-read-search /etc/shadow</code></p> <h4 id="_6-4-4-check-ptrace"><a href="#_6-4-4-check-ptrace" class="header-anchor">#</a> 6.4.4. check-ptrace</h4> <ul><li>检查SYS_PTRACE标志位,同时打印容器内部进程列表</li> <li>如果存在ptrace权限，容器同时挂载了主机的pid namespace 就可以逃逸</li> <li>RUN() -&gt; CheckPidInject() -&gt; ioutil.ReadFile(&quot;/proc/self/status&quot;) -&gt; FindAllStringSubmatch() -&gt; enableSysPtraceCap(mask) -&gt; ps.RunPs()</li></ul> <h4 id="_6-4-5-docker-api-pwn"><a href="#_6-4-5-docker-api-pwn" class="header-anchor">#</a> 6.4.5. docker-api-pwn</h4> <ul><li>Docker API 2375未授权访问，控制宿主机的dockerd创建一个新容器，并挂在宿主机根目录/到容器内部/host，然后执行传入的命令</li> <li>Run() -&gt; DockerRemoteAPIExploit(url, cmd) -&gt; CheckDockerRemoteAPI(api) -&gt; pull image -&gt; create container -&gt; get container id -&gt; start container</li></ul> <h4 id="_6-4-6-docker-sock-check"><a href="#_6-4-6-docker-sock-check" class="header-anchor">#</a> 6.4.6. docker-sock-check</h4> <ul><li>检查docker unix socket是否可用</li> <li>Run() -&gt; CheckDockerSock(sock) -&gt; os.Stat(path)-&gt;　util.UnixHttpSend(&quot;get&quot;, path, &quot;http://127.0.0.1/info&quot;, &quot;&quot;)</li></ul> <h4 id="_6-4-7-docker-sock-pwn"><a href="#_6-4-7-docker-sock-pwn" class="header-anchor">#</a> 6.4.7. docker-sock-pwn</h4> <ul><li>检查docker.sock能否访问，如果能尝试启动alpine容器执行命令</li> <li>Run() -&gt; DockerSockExploit(sock, cmd) -&gt; CheckDockerSock(sock) -&gt; DockerAPIPull(sock, &quot;alpine:latest&quot;) -&gt; DockerAPIRun(sock, cmd)</li></ul> <h4 id="_6-4-8-etcd-get-k8s-token"><a href="#_6-4-8-etcd-get-k8s-token" class="header-anchor">#</a> 6.4.8. etcd-get-k8s-token</h4> <ul><li>通过etcd获取k8s的toekn</li></ul> <p>-&gt; Run() -&gt; etcdctl.DoRequest(opt) -&gt; etcdctl.GetKeys -&gt; etcdctl.GetKeys(resp1, opt.Silent) -&gt; getPods(token, endpoint)</p> <h4 id="_6-4-9-istio-check"><a href="#_6-4-9-istio-check" class="header-anchor">#</a> 6.4.9. istio-Check</h4> <ul><li>检查当前的shell是否在istio(service mesh)中</li> <li>Run() -&gt; http.Get(&quot;http://httpbin.org/get&quot;) -&gt; strings.Contains(result.Header.XEnvoyPeerMetadataId, &quot;sidecar&quot;)</li></ul> <h4 id="_6-4-10-k8s-backdoor-daemonset"><a href="#_6-4-10-k8s-backdoor-daemonset" class="header-anchor">#</a> 6.4.10. k8s-backdoor-daemonset</h4> <ul><li>通过daemonset将用户指定的后门镜像部署到每个node。</li> <li></li></ul> <h4 id="_6-4-11-k8s-configmap-dump"><a href="#_6-4-11-k8s-configmap-dump" class="header-anchor">#</a> 6.4.11. k8s-configmap-dump</h4> <ul><li>拉取全部K8s Configmap信息保存到本地文件。</li></ul> <h4 id="_6-4-12-k8s-cronjob"><a href="#_6-4-12-k8s-cronjob" class="header-anchor">#</a> 6.4.12. k8s-cronjob</h4> <ul><li>部署K8s CronJob定时创建用户指定的image并运行cmd。</li></ul> <h4 id="_6-4-13-k8s-get-sa-token"><a href="#_6-4-13-k8s-get-sa-token" class="header-anchor">#</a> 6.4.13. k8s-get-sa-token</h4> <ul><li>绕过K8s RBAC</li> <li>如果当前的Pod有创建Pod权限，提权到Cluster Admin</li> <li>创建一个Pod并挂在目标service-account的token</li> <li>在Pod中读取该token并发送到攻击者的公网服务器。</li></ul> <h4 id="_6-4-14-k8s-kubelet-var-log-escape"><a href="#_6-4-14-k8s-kubelet-var-log-escape" class="header-anchor">#</a> 6.4.14. k8s-kubelet-var-log-escape</h4> <ul><li>Exploit container escape with kubelet log access &amp; /var/log mount</li></ul> <h4 id="_6-4-15-k8s-mitm-clusterip"><a href="#_6-4-15-k8s-mitm-clusterip" class="header-anchor">#</a> 6.4.15. k8s-mitm-clusterip</h4> <ul><li><p>K8s中间人攻击(CVE-2020-8554)</p></li> <li><p>漏洞只影响部分CNI插件和网络模式</p> <ul><li>部分CNI + Iptables 可劫持 POD network</li> <li>部分CNI + IPVS 可劫持 可劫持 NODE network</li> <li>Global Router + IPVS 可劫持 可劫持 NODE network</li></ul></li></ul> <h4 id="_6-4-16-k8s-psp-dump"><a href="#_6-4-16-k8s-psp-dump" class="header-anchor">#</a> 6.4.16. k8s-psp-dump</h4> <ul><li>对于已经获取了kubeconfig或sa账号权限，进而想要创建特殊配置的容器，但是受到了K8s Pod Security Policies的限制时；</li> <li>获取Pod Security Policies的规则信息。</li></ul> <h4 id="_6-4-17-k8s-secret-dump"><a href="#_6-4-17-k8s-secret-dump" class="header-anchor">#</a> 6.4.17. k8s-secret-dump</h4> <ul><li>拉取全部K8s Secrets</li></ul> <h4 id="_6-4-18-k8s-shadow-apiserver"><a href="#_6-4-18-k8s-shadow-apiserver" class="header-anchor">#</a> 6.4.18. k8s-shadow-apiserver</h4> <ul><li>部署一个shadow apiserver，该apiserver具有和集群中现存的apiserver一致的功能，同时开启了全部K8s管理权限，接受匿名请求且不保存审计日志。便于攻击者无痕迹的管理整个集群以及下发后续渗透行动。</li> <li>需要master node的create pod权限</li> <li>在攻入的pod内部查找API-server访问地址和凭据</li> <li>连接apiserver判断权限</li> <li>获取apiserver原有配置</li> <li>修改配置</li> <li>重新部署shadow apiserver</li></ul> <h4 id="_6-4-19-kubelet-exec"><a href="#_6-4-19-kubelet-exec" class="header-anchor">#</a> 6.4.19. kubelet-exec</h4> <ul><li>Attack the kubelet endpoint.Support anonymous access or token designation</li></ul> <h4 id="_6-4-20-lxcfs-rw"><a href="#_6-4-20-lxcfs-rw" class="header-anchor">#</a> 6.4.20. lxcfs-rw</h4> <ul><li>POD挂载了LXCFS目录包含CGOURP目录，并且对CGROUP有写权限</li></ul> <h4 id="_6-4-21-lxcfs-rw-cgroup"><a href="#_6-4-21-lxcfs-rw-cgroup" class="header-anchor">#</a> 6.4.21. lxcfs-rw-cgroup</h4> <ul><li>escape container by cgroup when root has LXCFS read &amp; write privilege,</li></ul> <h4 id="_6-4-22-mount-cgroup"><a href="#_6-4-22-mount-cgroup" class="header-anchor">#</a> 6.4.22. mount-cgroup</h4> <ul><li>逃逸与宿主机共享cgroup的容器</li> <li>将宿主机cgroup目录挂载到容器内，随后劫持宿主机cgroup的release_agent文件，通过linux cgroup notify_on_release机制触发shellcode执行，完成逃逸。</li></ul> <h4 id="_6-4-23-mount-disk"><a href="#_6-4-23-mount-disk" class="header-anchor">#</a> 6.4.23. mount-disk</h4> <ul><li><p>自动化逃逸有设备操作权限的容器</p> <ul><li>识别当前容器内的挂载情况</li> <li>将宿主机的物理磁盘挂载到容器中</li> <li>编辑宿主机文件(如修改宿主机的/etc/crontab)完成逃逸。</li></ul></li> <li><p>Run()</p> <ul><li>AllDiskMount()</li> <li>disk.Partitions(false)</li> <li>util.RemoveDuplicateElement(devices)</li> <li>MountToRandomTarget(device)</li></ul></li></ul> <h4 id="_6-4-24-mount-procfs"><a href="#_6-4-24-mount-procfs" class="header-anchor">#</a> 6.4.24. mount-procfs</h4> <ul><li><p>逃逸挂载宿主机/proc目录的容器</p> <ul><li>将用户指定的shell命令指向宿主机/sys/kernel/core_pattern文件，在容器空间通过segment fault触发core dump，进而触发shellcode执行。</li></ul></li> <li><p>Run()</p></li> <li><p>ProcfsExploit(procDir, shellPayload)</p></li> <li><p>checkEnvFirst()</p></li> <li><p>GetDockerAbsPath()</p></li> <li><p>util.RandString(5)</p></li> <li><p>util.RewriteFile</p></li> <li><p>triggerSegmentFault()</p></li></ul> <h4 id="_6-4-25-registry-brute"><a href="#_6-4-25-registry-brute" class="header-anchor">#</a> 6.4.25. registry-brute</h4> <ul><li>暴力破解registry</li> <li>Run() -&gt; checkLogin() -&gt; http.Client{}.Do()</li></ul> <h4 id="_6-4-26-reverse-shell"><a href="#_6-4-26-reverse-shell" class="header-anchor">#</a> 6.4.26. reverse-shell</h4> <ul><li>执行一个反弹shell</li> <li>Run() -&gt; ReverseShell() -&gt; os/exec.Command().Run()</li></ul> <h4 id="_6-4-27-rewrite-cgroup-devices"><a href="#_6-4-27-rewrite-cgroup-devices" class="header-anchor">#</a> 6.4.27. rewrite-cgroup-devices</h4> <ul><li><p>sys_admin</p></li> <li><p>Run()</p> <ul><li><p>newDevicesCgroup()</p> <ul><li>mount -t cgroup -o devices devices /tmp/cdk_dcgroup**</li></ul></li> <li><p>findCurrentCgroupENV()</p></li> <li><p>util.GetMountInfo()</p></li> <li><p>util.SetBlockAccessible(devicesAllowPath)</p></li> <li><p>util.FindTargetDeviceID(&amp;mi)</p> <ul><li>util.MakeDev(mi.Major, mi.Minor)</li> <li>syscall.Mknod(&quot;./cdk_mknod_result&quot;, syscall.S_IFBLK|uint32(os.FileMode(0700)), dev)</li></ul></li></ul></li></ul> <h4 id="_6-4-28-runc-pwn"><a href="#_6-4-28-runc-pwn" class="header-anchor">#</a> 6.4.28. runc-pwn</h4> <ul><li><p>CVE-2019-5736</p> <ul><li>过特定的容器镜像或者exec操作可以获取到宿主机的runc执行时的文件句柄并修改掉runc的二进制文件，从而获取到宿主机的root执行权限</li> <li>影响版本 Docker版本 &lt; 18.09.2 or runc版本 &lt;= 1.0-rc6</li></ul></li> <li><p>Run() - dockerRuncPwn(cmd)</p></li></ul> <h4 id="_6-4-29-service-probe"><a href="#_6-4-29-service-probe" class="header-anchor">#</a> 6.4.29. service-probe</h4> <ul><li><p>端口扫描</p></li> <li><p>Run()</p></li> <li><p>probe.TCPScanExploitAPI(args[0])</p> <ul><li>net.DialTimeout(&quot;tcp&quot;, target, timeout)</li></ul></li></ul> <h4 id="_6-4-30-shim-pwn"><a href="#_6-4-30-shim-pwn" class="header-anchor">#</a> 6.4.30. shim-pwn</h4> <ul><li><p>自动化逃逸CVE-2020-15257，反弹宿主机的shell到远端服务器。</p></li> <li><p>Run()</p></li> <li><p>ContainerdPwn()</p> <ul><li>ContainerdPwn(shellCmd, &quot;&quot;, &quot;&quot;)</li> <li>ContainerdPwn(shellCmd, &quot;&quot;, &quot;&quot;)</li></ul></li> <li><p>getShimSockets()</p></li> <li><p>containerdShimApiExp()</p></li></ul> <h4 id="_6-4-31-webshell-deploy"><a href="#_6-4-31-webshell-deploy" class="header-anchor">#</a> 6.4.31. webshell-deploy</h4> <ul><li><p>生成接受随机POST参数的PHP或JSP webshell写入指定文件。</p> <ul><li>var WebShellCodeJSP = &quot;&lt;%Runtime.getRuntime().exec(request.getParameter(&quot;$SECRET_PARAM&quot;));%&gt;&quot;</li> <li>var WebShellCodePHP = &quot;<code>&lt;?php @eval($_POST['$SECRET_PARAM']);?&gt;</code>&quot;</li></ul></li> <li><p>Run() -&gt; deployWebShell(fileType,path) -&gt; param = &quot;cdk_&quot; + util.RandString(7)</p></li></ul> <h2 id="_7-tool-部分"><a href="#_7-tool-部分" class="header-anchor">#</a> 7. tool 部分</h2> <ul><li><p>dockerd_api</p> <ul><li>ucurl</li> <li>dcurl</li> <li>net.http</li></ul></li> <li><p>etcdctl</p> <ul><li>ectl http.NewRequest</li></ul></li> <li><p>kubectl</p> <ul><li>kcurl http.NewRequest</li></ul></li> <li><p>netcat</p> <ul><li>net.ListenPacket</li> <li>net.Dial</li> <li>io.Copy</li></ul></li> <li><p>network</p> <ul><li>ifcofnig net.Interfaces()</li></ul></li> <li><p>probe</p> <ul><li>tcp connet 端口扫描 net.DialTimeout</li></ul></li> <li><p>ps</p> <ul><li>github.com/shirou/gopsutil 获取系统信息的一个包，类似 python 的 psutil</li></ul></li> <li><p>vi</p> <p>-<code>https://github.com/bkthomps/Ven</code> 一个 go 写类似 vim 的文本编辑器</p></li></ul> <h2 id="_8-参考资料"><a href="#_8-参考资料" class="header-anchor">#</a> 8. 参考资料</h2> <blockquote><p><a href="https://www.freebuf.com/sectool/261432.html" target="_blank" rel="noopener noreferrer">CDK：一款针对容器场景的渗透工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/4/2023, 5:08:16 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c319bac8.js" defer></script><script src="/assets/js/2.ee734a59.js" defer></script><script src="/assets/js/126.5632c4d7.js" defer></script>
  </body>
</html>
