<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GC(Garbage collection)垃圾回收 | Hot</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="安全开发工程师(打杂工程师)的学习笔记">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.c319bac8.js" as="script"><link rel="preload" href="/assets/js/2.ee734a59.js" as="script"><link rel="preload" href="/assets/js/54.1e75d52b.js" as="script"><link rel="prefetch" href="/assets/js/10.9841cdef.js"><link rel="prefetch" href="/assets/js/100.98c51b8e.js"><link rel="prefetch" href="/assets/js/101.80ca1839.js"><link rel="prefetch" href="/assets/js/102.1c33cf56.js"><link rel="prefetch" href="/assets/js/103.b0b93725.js"><link rel="prefetch" href="/assets/js/104.c0c62484.js"><link rel="prefetch" href="/assets/js/105.1134daba.js"><link rel="prefetch" href="/assets/js/106.f9a27c7b.js"><link rel="prefetch" href="/assets/js/107.d3560c2c.js"><link rel="prefetch" href="/assets/js/108.dc824726.js"><link rel="prefetch" href="/assets/js/109.56b97cf6.js"><link rel="prefetch" href="/assets/js/11.8bb5db91.js"><link rel="prefetch" href="/assets/js/110.9893b030.js"><link rel="prefetch" href="/assets/js/111.53623519.js"><link rel="prefetch" href="/assets/js/112.e5269575.js"><link rel="prefetch" href="/assets/js/113.2a3d6326.js"><link rel="prefetch" href="/assets/js/114.f28d91ec.js"><link rel="prefetch" href="/assets/js/115.4219f56e.js"><link rel="prefetch" href="/assets/js/116.2f15c358.js"><link rel="prefetch" href="/assets/js/117.7e79e8c3.js"><link rel="prefetch" href="/assets/js/118.cd0ccb4e.js"><link rel="prefetch" href="/assets/js/119.1a8f3bb4.js"><link rel="prefetch" href="/assets/js/12.c3457dbf.js"><link rel="prefetch" href="/assets/js/120.22b3dd05.js"><link rel="prefetch" href="/assets/js/121.48115499.js"><link rel="prefetch" href="/assets/js/122.49df4874.js"><link rel="prefetch" href="/assets/js/123.bb366ac5.js"><link rel="prefetch" href="/assets/js/124.a1091dce.js"><link rel="prefetch" href="/assets/js/125.cba9e1c7.js"><link rel="prefetch" href="/assets/js/126.5632c4d7.js"><link rel="prefetch" href="/assets/js/127.83f20d12.js"><link rel="prefetch" href="/assets/js/128.df2f79c7.js"><link rel="prefetch" href="/assets/js/129.714ec10b.js"><link rel="prefetch" href="/assets/js/13.5a5564aa.js"><link rel="prefetch" href="/assets/js/130.f648ae53.js"><link rel="prefetch" href="/assets/js/14.31b1fb86.js"><link rel="prefetch" href="/assets/js/15.1f1a4999.js"><link rel="prefetch" href="/assets/js/16.2445c170.js"><link rel="prefetch" href="/assets/js/17.00149ca9.js"><link rel="prefetch" href="/assets/js/18.14f17999.js"><link rel="prefetch" href="/assets/js/19.4dfbf270.js"><link rel="prefetch" href="/assets/js/20.4f419716.js"><link rel="prefetch" href="/assets/js/21.04f10048.js"><link rel="prefetch" href="/assets/js/22.d5ea4ea8.js"><link rel="prefetch" href="/assets/js/23.2da0cb4d.js"><link rel="prefetch" href="/assets/js/24.171bad48.js"><link rel="prefetch" href="/assets/js/25.c648bffe.js"><link rel="prefetch" href="/assets/js/26.f7412ad6.js"><link rel="prefetch" href="/assets/js/27.3358de23.js"><link rel="prefetch" href="/assets/js/28.f4a4badf.js"><link rel="prefetch" href="/assets/js/29.5581c8fb.js"><link rel="prefetch" href="/assets/js/3.208249f8.js"><link rel="prefetch" href="/assets/js/30.4f07acfb.js"><link rel="prefetch" href="/assets/js/31.ad87b1d0.js"><link rel="prefetch" href="/assets/js/32.218c7530.js"><link rel="prefetch" href="/assets/js/33.06ce8d5f.js"><link rel="prefetch" href="/assets/js/34.e645d5f9.js"><link rel="prefetch" href="/assets/js/35.d3c03632.js"><link rel="prefetch" href="/assets/js/36.3b7139b6.js"><link rel="prefetch" href="/assets/js/37.9d30b16f.js"><link rel="prefetch" href="/assets/js/38.37e19265.js"><link rel="prefetch" href="/assets/js/39.a7a5a417.js"><link rel="prefetch" href="/assets/js/4.2ecfd9d7.js"><link rel="prefetch" href="/assets/js/40.8bd9d455.js"><link rel="prefetch" href="/assets/js/41.6a059dcc.js"><link rel="prefetch" href="/assets/js/42.e2361cae.js"><link rel="prefetch" href="/assets/js/43.7101e1e6.js"><link rel="prefetch" href="/assets/js/44.d8df0a7a.js"><link rel="prefetch" href="/assets/js/45.7b4583e6.js"><link rel="prefetch" href="/assets/js/46.6cf5ac92.js"><link rel="prefetch" href="/assets/js/47.ffd093f8.js"><link rel="prefetch" href="/assets/js/48.f69288ff.js"><link rel="prefetch" href="/assets/js/49.006a40a0.js"><link rel="prefetch" href="/assets/js/5.20014036.js"><link rel="prefetch" href="/assets/js/50.2a75a383.js"><link rel="prefetch" href="/assets/js/51.192e7cb9.js"><link rel="prefetch" href="/assets/js/52.cc5ea856.js"><link rel="prefetch" href="/assets/js/53.b963fae3.js"><link rel="prefetch" href="/assets/js/55.aaf95197.js"><link rel="prefetch" href="/assets/js/56.b57fb18c.js"><link rel="prefetch" href="/assets/js/57.d6ec3a28.js"><link rel="prefetch" href="/assets/js/58.a59a2bb3.js"><link rel="prefetch" href="/assets/js/59.2fd766d2.js"><link rel="prefetch" href="/assets/js/6.1aac11ee.js"><link rel="prefetch" href="/assets/js/60.9e6636d0.js"><link rel="prefetch" href="/assets/js/61.83fb732b.js"><link rel="prefetch" href="/assets/js/62.4ade8f03.js"><link rel="prefetch" href="/assets/js/63.bc5bd52e.js"><link rel="prefetch" href="/assets/js/64.0ee3dd03.js"><link rel="prefetch" href="/assets/js/65.ef7b2f39.js"><link rel="prefetch" href="/assets/js/66.c4321bd0.js"><link rel="prefetch" href="/assets/js/67.d0758688.js"><link rel="prefetch" href="/assets/js/68.014193b5.js"><link rel="prefetch" href="/assets/js/69.a6114edb.js"><link rel="prefetch" href="/assets/js/7.1848bf21.js"><link rel="prefetch" href="/assets/js/70.e685c54f.js"><link rel="prefetch" href="/assets/js/71.504c2b6b.js"><link rel="prefetch" href="/assets/js/72.4c7505ad.js"><link rel="prefetch" href="/assets/js/73.6790e908.js"><link rel="prefetch" href="/assets/js/74.71d69108.js"><link rel="prefetch" href="/assets/js/75.72af672f.js"><link rel="prefetch" href="/assets/js/76.c4a9226c.js"><link rel="prefetch" href="/assets/js/77.d38a498d.js"><link rel="prefetch" href="/assets/js/78.871d750a.js"><link rel="prefetch" href="/assets/js/79.527e7a49.js"><link rel="prefetch" href="/assets/js/8.8534ef4e.js"><link rel="prefetch" href="/assets/js/80.715f442a.js"><link rel="prefetch" href="/assets/js/81.74a2b8bd.js"><link rel="prefetch" href="/assets/js/82.066897b9.js"><link rel="prefetch" href="/assets/js/83.c264466b.js"><link rel="prefetch" href="/assets/js/84.18734103.js"><link rel="prefetch" href="/assets/js/85.afd2f665.js"><link rel="prefetch" href="/assets/js/86.073fdd24.js"><link rel="prefetch" href="/assets/js/87.29303003.js"><link rel="prefetch" href="/assets/js/88.d3d4f30c.js"><link rel="prefetch" href="/assets/js/89.56c3e387.js"><link rel="prefetch" href="/assets/js/9.73e739d0.js"><link rel="prefetch" href="/assets/js/90.022513aa.js"><link rel="prefetch" href="/assets/js/91.3cece5cd.js"><link rel="prefetch" href="/assets/js/92.1f9fa6f9.js"><link rel="prefetch" href="/assets/js/93.35733127.js"><link rel="prefetch" href="/assets/js/94.71526dfb.js"><link rel="prefetch" href="/assets/js/95.eff5cd3e.js"><link rel="prefetch" href="/assets/js/96.a30824e0.js"><link rel="prefetch" href="/assets/js/97.1e11427f.js"><link rel="prefetch" href="/assets/js/98.522292bb.js"><link rel="prefetch" href="/assets/js/99.6bf29dfd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Hot</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sec/" class="nav-link">
  安全
</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  开发
</a></div><div class="nav-item"><a href="/ops/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  杂记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zmf963/showip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  show ip
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/subdomain" target="_blank" rel="noopener noreferrer" class="nav-link external">
  subdomain
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/hotfinger" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hotfinger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/HotSec" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/sec/" class="nav-link">
  安全
</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  开发
</a></div><div class="nav-item"><a href="/ops/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  杂记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zmf963/showip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  show ip
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/subdomain" target="_blank" rel="noopener noreferrer" class="nav-link external">
  subdomain
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/HotSec/hotfinger" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hotfinger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/HotSec" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gc-garbage-collection-垃圾回收"><a href="#gc-garbage-collection-垃圾回收" class="header-anchor">#</a> GC(Garbage collection)垃圾回收</h1> <h2 id="常见gc算法"><a href="#常见gc算法" class="header-anchor">#</a> 常见GC算法</h2> <p>业界常见的比较知名的垃圾回收算法有：</p> <p><strong>1.</strong> <strong>引用计数(Reference counting)</strong> ：对每个对象维护一个引用计数，当引用计数器为零时回收该对象。代表语言如 Python。</p> <ul><li>优点：简单有效，对象可以被很快回收，不会出现内存耗尽或达到某个阀值时才回收。</li> <li>缺点：很明显，对每个对象维护引用计数有一定代价，而且致命的是无法处理循环引用的问题。</li></ul> <p><strong>2.</strong> <strong>标记-清除(Mark and Sweep)</strong> ：为解决循环引用问题而提出，算法从<strong>根对象</strong>开始遍历程序所有对象的引用，可达的对象被标记，最终没被标记的对象被删除回收。代表语言如 Golang(三色标记)。</p> <ul><li>优点：解决循环引用的问题，并且在算法执行期间不会产生额外的开销。</li> <li>缺点：需要 STW(stop the world)，即执行期间需要程序暂停，并且容易在经过多次『标记-清除』循环后导致内存碎片化。</li></ul> <p><strong>3.</strong> <strong>停止-复制(Stop-and-Copy)</strong> ：与标记-清除算法类似，差异在于如何处理这些可达的存活对象。该算法将整个堆空间被切分活动区和空闲区，垃圾收集时将所有的可达的存活对象复制到另一区，原本半区的就可以被回收，程序会在新的活动区中分配内存。</p> <ul><li>优点：运行高效且不容易产生内存碎片，基本解决了标记-清除内存碎片化的问题。</li> <li>缺点：需要 STW，收集器必须复制所有的活动对象，这增加了程序等待时间，并且在同一时间内只能使用整个内存空间的一半。</li></ul> <p><strong>3.</strong> <strong>标记-压缩(Mark-and-Compact)</strong> ：标记阶段与标记-清除算法相同，压缩（整理）阶段不是直接清理，而是让所有的对象都向一端移动，按顺序排放更新对应的指针，然后清理掉端边界以外的内存。</p> <ul><li>优点：避免了标记-清除的碎片化问题，同时也避免了停止复制算法的内存空间减半问题。</li> <li>缺点：需要 STW，低效，因为增加了 copy 和更新指针的过程。</li></ul> <p><strong>5.</strong> <strong>分代收集(Generational Collection)</strong> ：与其说是一种新算法不如说是一种优化策略，目前很流行。算法按照对象生命周期长短划分不同的代空间，生命周期长的放入老年代，短的放入新生代，从而区别不同的回收算法策略和频率，让各算法充分发挥优势。代表语言如 Java。</p> <ul><li>优点：可结合其他检测算法，回收性能好。</li> <li>缺点：算法比较复杂。</li></ul> <p>没有绝对好和坏的解决方案，在真正语言实现中一般都是几种算法结合使用，下面主要来探讨 Python 中的垃圾回收策略。</p> <h2 id="python垃圾回收机制"><a href="#python垃圾回收机制" class="header-anchor">#</a> Python垃圾回收机制</h2> <p><strong>Python的垃圾回收机制采用引用计数机制为主，标记-清除和分代回收机制为辅的策略。其中，标记-清除机制用来解决计数引用带来的循环引用而无法释放内存的问题，分代回收机制是为提升垃圾回收的效率。</strong></p> <h3 id="python垃圾回收的时机"><a href="#python垃圾回收的时机" class="header-anchor">#</a> Python垃圾回收的时机</h3> <p>1、用户显示调用gc.collect()
2、每次Python为新对象分配内存时，检查threshold阀值，当对象数量超过threshold设置的阀值就开始进行垃圾回收。</p> <h2 id="引用计数"><a href="#引用计数" class="header-anchor">#</a> 引用计数</h2> <ul><li>优点
<ul><li>简单</li> <li>实时性：一旦没有引用，内存就直接释放了,处理回收内存的时间分摊到了平时.</li></ul></li> <li>缺点
<ol><li>维护引用计数消耗资源</li> <li>循环引用</li> <li>线程锁定（CPython无法摆脱GIL的原因之一）</li></ol></li></ul> <p>查看一个对象的引用计数</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> sys
a <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span> <span class="token comment"># 1</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment"># 2 调用函数传入a,会让a的引用计数加1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><p>引用计数+1</p> <ul><li><p>对象被创建 a = [111]  1</p></li> <li><p>对象被引用 b = a  2</p></li> <li><p>对象被作为参数，传入一个函数中 sys.getrefcount(a) 3</p></li> <li><p>对象作为一个元素，存储在容器中 c = [a] 3</p></li> <li><div class="language-python line-numbers-mode"><pre class="language-python"><code>a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">111</span><span class="token punctuation">]</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">2</span>
b <span class="token operator">=</span> a
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">3</span>
c <span class="token operator">=</span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul></li> <li><p>引用计数-1</p> <ul><li>使用del语句对对象别名显式的销毁(例如：del b)</li> <li>对象所在的容器被销毁或从容器中删除对象</li> <li>引用超出作用域或被重新赋值</li></ul></li> <li><p>触发垃圾回收</p> <ul><li>调用gc.collect()</li> <li>当gc模块的计数器达到阈值</li> <li>程序退出的时候</li></ul></li></ul> <h2 id="标记清除"><a href="#标记清除" class="header-anchor">#</a> 标记清除</h2> <ul><li>引用计数能够解决大多数垃圾回收的问题，但是遇到两个对象相互引用的情况，del语句可以减少引用次数，但是引用计数不会归0，对象也就不会被销毁，从而造成了内存泄漏问题。针对该情况，Python引入了标记-清除机制。</li> <li>标记阶段，遍历所有的对象，如果是可达的（reachable），也就是还有对象引用它，那么就标记该对象为可达</li> <li>清除阶段，再次遍历对象，如果发现某个对象没有标记为可达（即为Unreachable），则就将其回收</li></ul> <h3 id="循环引用"><a href="#循环引用" class="header-anchor">#</a> 循环引用</h3> <ul><li>循环引用只有在容器对象才会产生，比如字典，元组，列表等。</li> <li>产生循环引用情况
<ul><li>对象包含本身的引用 <code>a = [1,2] a = [a,3]</code></li> <li>两个对象之间相互引用</li></ul></li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> sys
a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">2</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token number">2</span>
a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">2</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token number">3</span>
b<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token number">3</span>
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token number">3</span>
<span class="token keyword">del</span> a
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">&quot;&lt;pyshell#15&gt;&quot;</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
NameError<span class="token punctuation">:</span> name <span class="token string">'a'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined
sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="分代回收"><a href="#分代回收" class="header-anchor">#</a> 分代回收</h2> <p>把对象分为三代，一开始，对象在创建的时候，放在一代中，如果在一次一代的垃圾检查中，该对象存活下来，就会被放到二代中，同理在一次二代的垃圾检查中，该对象存活下来，就会被放到三代中</p> <p>1、新创建的对象做为0代
2、每执行一个【标记-删除】，存活的对象代数就+1
3、代数越高的对象（存活越持久的对象），进行【标记-删除】的时间间隔就越长。这个间隔，江湖人称阀值。</p> <ol><li>gc模块里面会有一个长度为3的列表计数器，可以通过gc.get_count()获取
<ol><li>gc.set_threshold(threshold0[, threshold1[, threshold2]) 设置自动执行垃圾回收的频率</li> <li>例如(700,10,10)每一次计数器的增加，gc模块就会检查增加后的计数是否达到阀值的数目</li> <li>700表示阈值，10表示每清理10次零代就清理一次一代，第二个10表示每清理10次一代链表就清理二代一次</li></ol></li></ol> <ul><li>注意点：
<ul><li>gc模块唯一处理不了的是循环引用的类都有__del__方法，所以项目中要避免定义__del__方法</li></ul></li></ul> <h3 id="环状双向链表-refchain"><a href="#环状双向链表-refchain" class="header-anchor">#</a> 环状双向链表 refchain</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>object -----<span class="token operator">&gt;</span> +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ <span class="token punctuation">\</span>
              <span class="token operator">|</span>                    ob_refcnt                  <span class="token operator">|</span> <span class="token operator">|</span>
              +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ <span class="token operator">|</span> PyObject_HEAD
              <span class="token operator">|</span>                    *ob_type                   <span class="token operator">|</span> <span class="token operator">|</span>
              +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ /
              <span class="token operator">|</span>                      <span class="token punctuation">..</span>.                      <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>              +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ <span class="token punctuation">\</span>
              <span class="token operator">|</span>                    *_gc_next                  <span class="token operator">|</span> <span class="token operator">|</span>
              +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ <span class="token operator">|</span> PyGC_Head
              <span class="token operator">|</span>                    *_gc_prev                  <span class="token operator">|</span> <span class="token operator">|</span>
object -----<span class="token operator">&gt;</span> +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ /
              <span class="token operator">|</span>                    ob_refcnt                  <span class="token operator">|</span> <span class="token punctuation">\</span>
              +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ <span class="token operator">|</span> PyObject_HEAD
              <span class="token operator">|</span>                    *ob_type                   <span class="token operator">|</span> <span class="token operator">|</span>
              +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ /
              <span class="token operator">|</span>                      <span class="token punctuation">..</span>.                      <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="池化技术"><a href="#池化技术" class="header-anchor">#</a> 池化技术</h2> <h2 id="备忘"><a href="#备忘" class="header-anchor">#</a> 备忘</h2> <p>提示或建议</p> <ol><li>如果你可以保证不会出现循环引用，则可以通过 gc.disable 完全禁用 GC，在某些情况下，禁用 GC 并手动 gc.collect() 很有用。</li> <li>为避免产生循环引用，可考虑使用弱引用 weakref ，weakref.ref 不会增加引用计数，并且当对象只剩弱引用时不会保持其活性（可以被 GC 正常回收），并在对象被释放后安全返回 None。</li> <li>循环在现实生活中很容易发生。通常，您会在图形，链接列表或结构中遇到它们，在其中需要跟踪对象之间的关系。如果您的程序工作量大且要求低延迟，则需要尽可能避免参考周期。</li></ol> <p>查找或调试分析循环引用</p> <ol><li>标准 gc 模块 提供了接口可以帮助调试，例如 gc.set_debug(gc.DEBUG_SAVEALL)，则找到的所有的不可达对象将追加到 gc.garbage 列表中，你可以在其中查看。</li> <li>当你发现了循环引用的对象后，就可以使用上文中提到的 objgraph 来直观的探索它与其它对象间的关系。</li></ol> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <blockquote><p><a href="https://devguide.python.org/internals/garbage-collector/" target="_blank" rel="noopener noreferrer">https://devguide.python.org/internals/garbage-collector/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://segmentfault.com/a/1190000016078708" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000016078708<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://blog.csdn.net/yueguanghaidao/article/details/11274737" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/yueguanghaidao/article/details/11274737<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://blog.csdn.net/Python_222/article/details/130012232?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-130012232-blog-87879064.235%5Ev39%5Epc_relevant_yljh&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-130012232-blog-87879064.235%5Ev39%5Epc_relevant_yljh&amp;utm_relevant_index=2" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/Python_222/article/details/130012232?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-130012232-blog-87879064.235%5Ev39%5Epc_relevant_yljh&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-130012232-blog-87879064.235%5Ev39%5Epc_relevant_yljh&amp;utm_relevant_index=2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/16/2023, 7:38:35 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c319bac8.js" defer></script><script src="/assets/js/2.ee734a59.js" defer></script><script src="/assets/js/54.1e75d52b.js" defer></script>
  </body>
</html>
